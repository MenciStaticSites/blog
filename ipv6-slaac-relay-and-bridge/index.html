<!doctype html><html lang=zh-CN><head><title>SLAAC 环境下的 IPv6 桥接与中继 - Menci&#39;s Blog</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=author content=Menci><meta name=description content="IPv6 网络已经日渐普及，中国的绝大多数家庭宽带或校园网用户均可获得 IPv6 地址。对于手动组网的用户来说，可..."><meta name=keywords content=""><link rel=alternate type=application/atom+xml title="ATOM 1.0" href=/atom.xml><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=renderer content=webkit><meta name=theme-color content=#ffffff><link rel="shortcut icon" type=image/x-icon href=//static.cdn.menci.xyz/menci-blog/avatar.6e993e78.png crossorigin=anonymous><link rel=stylesheet href=//cdnjs.baoshuo.ren/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css crossorigin=anonymous><link rel=stylesheet href=//cdnjs.baoshuo.ren/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css crossorigin=anonymous><link rel=stylesheet href=//cdnjs.baoshuo.ren/ajax/libs/KaTeX/0.15.2/katex.min.css crossorigin=anonymous><link rel=stylesheet href=//static.cdn.menci.xyz/menci-blog/css/journal.b205a034.css crossorigin=anonymous><link rel=stylesheet href="//cdn.menci.xyz/fonts/css2?family=Noto+Sans+SC:wght@300%3B400%3B600&family=Source+Sans+Pro:wght@400%3B600&family=Lato:wght@400%3B500&family=Hind+Vadodara:wght@300%3B400&family=Montserrat&family=Fira+Code&family=Material+Icons&display=block" crossorigin=anonymous><script async data-domain=blog.men.ci src=//stat.u.sb/js/plausible.js></script><meta name=generator content="Hexo 7.3.0"></head><body><div id=top></div><div id=app><div class=single-column-drawer-container ref=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block false drawer-menu-item" href=https://blog.men.ci>首页 </a><a class="a-block false drawer-menu-item" href=/archives/ >归档 </a><a class="a-block false drawer-menu-item" href=/tags/ >标签 </a><a class="a-block false drawer-menu-item" href=/friends/ >朋友们 </a><a class="a-block false drawer-menu-item" href=/about-me/ >关于我</a></div></div></div><transition name=fade><div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav ref=navBar class="navbar navbar-light single-column-nav-container sticky-top"><div ref=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer><i class=material-icons>menu</i></button> <a ref=navTitle class=navbar-brand href=/ >Menci&#39;s Blog</a></div></nav><div class=single-column-header-container ref=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=/ ><div class=single-column-header-title>Menci's Blog</div><div class=single-column-header-subtitle>念念不忘，必有回响</div></a></div><div ref=sideContainer class=side-container><a class="a-block false nav-head" href=/ ><div class=nav-title>Menci's Blog</div><div class=nav-subtitle>念念不忘，必有回响</div></a><div class=nav-link-list><a class="a-block false nav-link-item" href=/archives/ >归档 </a><a class="a-block false nav-link-item" href=/tags/ >标签 </a><a class="a-block false nav-link-item" href=/friends/ >朋友们 </a><a class="a-block false nav-link-item" href=/about-me/ >关于我</a></div><div class=nav-footer>Powered by <a href=https://hexo.io/ target=_blank rel="noreferrer noopener">Hexo</a><br>Theme <a href=https://github.com/Menci/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal</a> by <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a><br>&copy; 2024 <a href=https://blog.men.ci>Menci<i class=material-icons>favorite</i></a></div></div><div ref=extraContainer class=extra-container><div class=pagination><a id=globalBackToTop class="animated-visibility pagination-action" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a></div></div><div ref=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only style="background-image: url('')"><div class=post-title>SLAAC 环境下的 IPv6 桥接与中继<div class=post-meta><time datetime=2023-01-03T17:51:00.000Z itemprop=datePublished>2023-01-04 </time>&nbsp; <i class=material-icons style="">label</i> <a href=/tags/网络/ >网络</a>, <a href=/tags/Linux/ >Linux</a>, <a href=/tags/IPv6/ >IPv6</a>, <a href=/tags/防火墙/ >防火墙</a>, <a href=/tags/路由/ >路由</a></div></div></div><div class=post-body-wrapper><div class=post-body><ol class=toc><li class="toc-item toc-level-1"><a class=toc-link href=#%E5%8E%9F%E7%90%86><span class=toc-number>1.</span> <span class=toc-text>原理</span></a><ol class=toc-child><li class="toc-item toc-level-2"><a class=toc-link href=#slaac><span class=toc-number>1.1.</span> <span class=toc-text>SLAAC</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#ndp><span class=toc-number>1.2.</span> <span class=toc-text>NDP</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#pd><span class=toc-number>1.3.</span> <span class=toc-text>PD</span></a></li></ol></li><li class="toc-item toc-level-1"><a class=toc-link href=#%E9%97%AE%E9%A2%98><span class=toc-number>2.</span> <span class=toc-text>问题</span></a><ol class=toc-child><li class="toc-item toc-level-2"><a class=toc-link href=#%E4%B8%AD%E7%BB%A7><span class=toc-number>2.1.</span> <span class=toc-text>中继</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E7%9B%B4%E6%8E%A5%E6%A1%A5%E6%8E%A5><span class=toc-number>2.2.</span> <span class=toc-text>直接桥接</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%9F%BA%E4%BA%8E%E6%A1%A5%E6%8E%A5%E7%9A%84%E4%B8%AD%E7%BB%A7><span class=toc-number>2.3.</span> <span class=toc-text>基于桥接的中继</span></a></li></ol></li></ol><p>IPv6 网络已经日渐普及，中国的绝大多数家庭宽带或校园网用户均可获得 IPv6 地址。对于手动组网的用户来说，可以使用与 IPv4 一样的方式，配置 IPv6 NAT 来让内网设备接入 IPv6 网络。但我们往往希望不使用 NAT，而是让内网设备可以获得全局可路由的公网 IPv6 地址。本文将从 IPv6 网络的原理入手，介绍如何配置 Linux 路由器，使得内网设备可以直接获得上层网络下发的 IPv6 地址，并同时使自定义路由与防火墙可用。</p><span id=more></span><h1 id=%E5%8E%9F%E7%90%86 tabindex=-1>原理 <a class=headerlink href=#%E5%8E%9F%E7%90%86></a></h1><h2 id=slaac tabindex=-1>SLAAC <a class=headerlink href=#slaac></a></h2><p>SLAAC（Stateless Address Auto-Configuration，无状态地址自动配置）是 IPv6 网络中最常见的为单一主机分配地址的方式。一般来说，IPv6 终端网络使用 <code>/64</code> 的前缀长度，并使用 SLAAC 来配置每个主机的 <code>/64</code> 后缀。主机使用其网卡 MAC 地址来生成后缀，确保地址不会冲突。</p><span class=katex-display><span class=katex><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:3.8276em;vertical-align:-3.2164em;></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:0.6111em;><span style=top:-1.6659em;><span class=pstrut style=height:3em;></span><span class="mtight reset-size6 size3 sizing"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">prefix: </span></span><span class="mord text mtight"><span class="mord mtight texttt">/64</span></span><span class="mord text mtight"><span class="mord mtight"> network address</span></span></span></span></span><span style=top:-3em;><span class=pstrut style=height:3em;></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:0.6111em;><span class=svg-align style=top:-2.352em;><span class=pstrut style=height:3em;></span><span class=stretchy style=height:0.548em;min-width:1.6em;><span class=brace-left style=height:0.548em;><svg xmlns=http://www.w3.org/2000/svg width=400em height=0.548em viewBox="0 0 400000 548" preserveAspectRatio="xMinYMin slice"><path d="M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13
 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688
 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7
-331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z"></path></svg></span><span class=brace-center style=height:0.548em;><svg xmlns=http://www.w3.org/2000/svg width=400em height=0.548em viewBox="0 0 400000 548" preserveAspectRatio="xMidYMin slice"><path d="M199572 214
c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14
 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3
 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0
-5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z"></path></svg></span><span class=brace-right style=height:0.548em;><svg xmlns=http://www.w3.org/2000/svg width=400em height=0.548em viewBox="0 0 400000 548" preserveAspectRatio="xMaxYMin slice"><path d="M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3
 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237
-174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z"></path></svg></span></span></span><span style=top:-3em;><span class=pstrut style=height:3em;></span><span class=mord><span class="mord text"><span class="mord texttt">2409:8a20:85e5:cc40</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:0.648em;><span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.4702em;><span></span></span></span></span></span><span class="mord text"><span class="mord texttt">:</span></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:0.6111em;><span style=top:-1.152em;><span class=pstrut style=height:3.3592em;></span><span class="mtight reset-size6 size3 sizing"><span class="mord mtight"><span class="mord mtight"><span class=mtable><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.9417em;><span style=top:-4.0211em;><span class=pstrut style=height:3.0714em;></span><span class="mord reset-size3 size6 sizing"><span class="mord text"><span class=mord>suffix: </span></span><span class="mord text"><span class="mord texttt">/64</span></span><span class="mord text"><span class=mord> host address</span></span></span></span><span style=top:-2.2897em;><span class=pstrut style=height:3.0714em;></span><span class="mord reset-size3 size6 sizing"><span class="mord text"><span class=mord>(generated from MAC)</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.4417em;><span></span></span></span></span></span></span></span></span></span></span><span style=top:-3.3592em;><span class=pstrut style=height:3.3592em;></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:0.6111em;><span class=svg-align style=top:-2.352em;><span class=pstrut style=height:3em;></span><span class=stretchy style=height:0.548em;min-width:1.6em;><span class=brace-left style=height:0.548em;><svg xmlns=http://www.w3.org/2000/svg width=400em height=0.548em viewBox="0 0 400000 548" preserveAspectRatio="xMinYMin slice"><path d="M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13
 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688
 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7
-331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z"></path></svg></span><span class=brace-center style=height:0.548em;><svg xmlns=http://www.w3.org/2000/svg width=400em height=0.548em viewBox="0 0 400000 548" preserveAspectRatio="xMidYMin slice"><path d="M199572 214
c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14
 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3
 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0
-5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z"></path></svg></span><span class=brace-right style=height:0.548em;><svg xmlns=http://www.w3.org/2000/svg width=400em height=0.548em viewBox="0 0 400000 548" preserveAspectRatio="xMaxYMin slice"><path d="M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3
 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237
-174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z"></path></svg></span></span></span><span style=top:-3em;><span class=pstrut style=height:3em;></span><span class=mord><span class="mord text"><span class="mord texttt">0090:27ff:fe17:fc0f</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:0.648em;><span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:3.2164em;><span></span></span></span></span></span></span></span></span></span><p>这种配置方式的存在，得益于 IPv6 地址高达 128 位的地址空间。ISP 能够为每个用户网络分配 <code>/64</code> 乃至更大的地址空间，终端网络无需使用 DHCP 小心翼翼地在有限的地址池中为设备分配地址，也不需要使用 NAT 来让网络中的设备共享一个公网地址。</p><p>SLAAC 协议由两种数据包组成，它们都属于 ICMPv6：</p><ul><li><strong>Router Solicitation（路由请求）</strong>，由需要配置 IPv6 的主机发送的组播包，向网络中的路由器请求路由宣告。</li><li><strong>Router Advertisement（路由宣告）</strong>，由路由器在收到请求后发送，或配置变更时发送。包含前缀、路由、有效时长等信息，也包含 DNS 服务器地址等一些扩展。<ul><li>一些时候 SLAAC 不足以配置网络中的所有信息，仍然需要 DHCP，这种情况不是本文所介绍的重点，但可以用类似的方法解决。</li></ul></li></ul><p>主机在收到路由宣告后，会使用其中的信息来为自己配置 IPv6 地址和路由表。注意，由于 SLAAC 是无状态的，主机并不需要将选择的地址上报给路由器。</p><h2 id=ndp tabindex=-1>NDP <a class=headerlink href=#ndp></a></h2><p>与 IPv4 的 ARP 协议类似，IPv6 使用 NDP（Neighbor Discovery Protocol）协议来将同一网络中其他主机的 IP 地址对应到 MAC 地址。</p><p>这个过程与 ARP 基本一致，一方发送<strong>Neighbor Solicitation（邻居请求）<strong>组播包，包含所查询的 IPv6 地址，持有该地址主机返回</strong>Neighbor Advertisement（邻居宣告）</strong>。</p><h2 id=pd tabindex=-1>PD <a class=headerlink href=#pd></a></h2><p>PD（Prefix Delegation）是 DHCPv6 的一项扩展，用于 DHCP 服务器将一整段地址分配给 DHCP 客户端。这种情况一般常见于 ISP 为用户分配 IPv6 地址。在客户端获取地址时，DHCPv6 服务器（作为上级路由器）会添加一条路由，将整个被下发的网段路由到客户端。这样一来，整个地址块（一般为 <code>/64</code> 或者 <code class=punctuation-r>/60</code>）均可被客户端网络使用。</p><p>DHCPv6 客户端收到由 PD 下发的前缀后，即可通过 SLAAC 等方式为整个网络内的所有主机配置 IPv6 地址，这个过程不再需要上级路由的参与。这也是一般家用网络中最常见的 IPv6 地址分配方式。</p><h1 id=%E9%97%AE%E9%A2%98 tabindex=-1>问题 <a class=headerlink href=#%E9%97%AE%E9%A2%98></a></h1><div class=flex-wrapper><blockquote><p>如果我们的路由器本身处于一个没有 DHCPv6 PD 分配的环境中，只能通过 SLAAC 从上级路由（WAN）获得单个 IPv6 地址，应该如何为网络中（LAN）的主机分配 IPv6 地址？</p></blockquote></div><p>这种情况常见于校园网环境中，不存在 PD 前缀下发，只有 SLAAC 地址分配。以及，在一些家庭宽带环境下，ISP 提供的光猫完成了 PPPoE 拨号、DHCPv6 PD 获取前缀、SLAAC 下发地址的整个过程，接入光猫（上级路由）的路由器同样无法获得前缀。</p><h2 id=%E4%B8%AD%E7%BB%A7 tabindex=-1>中继 <a class=headerlink href=#%E4%B8%AD%E7%BB%A7></a></h2><p>在这种情况下，除 NAT 之外，使 LAN 中的终端设备接入 IPv6 的主要思路是，假装这些设备被直接接入到 WAN 中，从 WAN 上的上级路由获得 IPv6 地址，并在 LAN 和 WAN 之间对 SLAAC 和 NDP 协议进行代理 —— <b>双向转发 SLAAC 与 NDP 包，并将源 MAC 地址改为我们的路由器的 MAC 地址。</b>在 WAN 和 LAN 中的设备看来，对方网络中的 IP 地址由我们的路由器所持有，所有流量均由我们的路由器。</p><p>这种实现思路被称为 IPv6 中继（Relay）。OpenWrt 的 <code class=punctuation-r>6relayd</code>（早期）与 <code class=punctuation-r>odhcpd</code>（目前）实现了这个功能，在一般的 Linux 路由器上，我们也可以通过抓包来手动实现它（见 <a target=_blank rel=noopener href=https://github.com/Menci/magpie>Menci/magpie</a>），但实现较为复杂，运行效果并不好。</p><h2 id=%E7%9B%B4%E6%8E%A5%E6%A1%A5%E6%8E%A5 tabindex=-1>直接桥接 <a class=headerlink href=#%E7%9B%B4%E6%8E%A5%E6%A1%A5%E6%8E%A5></a></h2><p>我们可以将 IPv4 和 IPv6 视作独立的网络接口。假设我们有 WAN4、WAN6、LAN4、LAN6，将 WAN6 与 LAN6 桥接，保持 WAN4 与 LAN4 上原有的 NAT 配置。这样一来，桥接会使得 WAN 与 LAN 中主机的 IPv6 流量互通，无需关心地址分配与邻居发现上的任何问题。在 Linux 上，通过 <code>ebtables</code> 来配置：</p><div class=flex-wrapper><pre><code class=language-bash-prompt><span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>brctl</span><span style=color:#032F62> addif</span><span style=color:#032F62> br-lan</span><span style=color:#032F62> wan</span><span style=color:#6A737D> # 将 WAN 与 LAN 桥接</span></span>
<span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>ebtables</span><span style=color:#005CC5> -t</span><span style=color:#032F62> broute</span><span style=color:#005CC5> -A</span><span style=color:#032F62> BROUTING</span><span style=color:#005CC5> -p</span><span style=color:#032F62> !</span><span style=color:#032F62> IPv6</span><span style=color:#005CC5> -i</span><span style=color:#032F62> wan</span><span style=color:#005CC5> --logical-in</span><span style=color:#032F62> br-lan</span><span style=color:#005CC5> -j</span><span style=color:#032F62> DROP</span></span>
<span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>ebtables</span><span style=color:#005CC5> -t</span><span style=color:#032F62> filter</span><span style=color:#005CC5> -A</span><span style=color:#032F62> OUTPUT</span><span style=color:#005CC5> -p</span><span style=color:#032F62> !</span><span style=color:#032F62> IPv6</span><span style=color:#005CC5> --logical-out</span><span style=color:#032F62> br-lan</span><span style=color:#005CC5> -o</span><span style=color:#032F62> wan</span><span style=color:#005CC5> -j</span><span style=color:#032F62> DROP</span></span>
</code></pre></div><p>上述命令添加了两条 <code>ebtables</code> 规则。首先在 <code>broute</code> 链上，将 <code>br-lan</code> 从 <code>wan</code> 接口进入的非 IPv6 流量全部 DROP。在 <code>broute</code> 链上 DROP 数据包并不会使得数据包被丢弃，而是会使得该数据包不经过网桥，原样发到物理接口上。这样一来，<code class=punctuation-l>wan</code> 上进入的 IPv4 流量会在 <code>wan</code> 上被收到，不影响原有的 IPv4 NAT 配置，而 IPv6 流量会经过网桥 <code>br-lan</code> 与 LAN 上的主机互通。</p><p>第二条规则在 <code>filter</code> 链上，将 <code>br-lan</code> 上要发往 <code>wan</code> 接口的非 IPv6 流量全部 DROP，这保证了 <code>br-lan</code> 上的 IPv4 数据包在泛洪时不会将 LAN 侧的 IPv4 数据包泄漏到 WAN 上。</p><p>这种做法虽然解决了 LAN 上主机接入 IPv6 的问题，但 WAN 与 LAN 之间的 IPv6 流量不会经过路由器的三层，无法为其配置路由规则和防火墙规则。</p><h2 id=%E5%9F%BA%E4%BA%8E%E6%A1%A5%E6%8E%A5%E7%9A%84%E4%B8%AD%E7%BB%A7 tabindex=-1>基于桥接的中继 <a class=headerlink href=#%E5%9F%BA%E4%BA%8E%E6%A1%A5%E6%8E%A5%E7%9A%84%E4%B8%AD%E7%BB%A7></a></h2><p>考虑到桥接的实现方式，内核会在 MAC 表中记录每个 MAC 地址所在的接口，在需要时进行泛洪，所以能够天然地正确转发 NDP 的 NS 与 NA 包。不考虑对数据流量的转发，桥接的机制相当于为我们实现了 NDP 中继。</p><p>与手动实现中继有一点不同，桥接会<b>直接双向转发 SLAAC 与 NDP 包，不改变包的 MAC 地址。</b>在 WAN 和 LAN 中的设备看来，他们互相可以直接在同一二层中收到对方的 ICMPv6 消息，但实际上这些数据包由我们的路由器进行转发。WAN 和 LAN 上的交换机会分别记录对方网络中设备的 MAC 地址的所属方为我们的路由器，所以，双方会认为它们在同一个网络中，而双方之间的流量则自然而然地到达了我们的路由器。<strong>而我们希望不对数据流量进行二层交换，而是在利用桥接带来的连通性的同时，让数据流量经过三层进行路由。</strong></p><p>同样地，使用 <code>ebtables</code> 来实现流量分离：</p><div class=flex-wrapper><pre><code class=language-bash-prompt><span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6A737D># br-lan 为上一节中桥接了 WAN 与 LAN 的网桥</span></span>
<span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6A737D># 如果上级路由使用 DHCPv6 下发地址，同样需要将 DHCPv6 数据包跳过处理</span></span>
<span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>ebtables</span><span style=color:#005CC5> -t</span><span style=color:#032F62> nat</span><span style=color:#005CC5> -A</span><span style=color:#032F62> PREROUTING</span><span style=color:#005CC5> -p</span><span style=color:#032F62> IPv6</span><span style=color:#005CC5> --logical-in</span><span style=color:#032F62> br-lan</span><span style=color:#005CC5> --ip6-proto</span><span style=color:#032F62> ipv6-icmp</span><span style=color:#005CC5> --ip6-icmp-type</span><span style=color:#032F62> router-solicitation</span><span style=color:#005CC5> -j</span><span style=color:#032F62> ACCEPT</span></span>
<span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>ebtables</span><span style=color:#005CC5> -t</span><span style=color:#032F62> nat</span><span style=color:#005CC5> -A</span><span style=color:#032F62> PREROUTING</span><span style=color:#005CC5> -p</span><span style=color:#032F62> IPv6</span><span style=color:#005CC5> --logical-in</span><span style=color:#032F62> br-lan</span><span style=color:#005CC5> --ip6-proto</span><span style=color:#032F62> ipv6-icmp</span><span style=color:#005CC5> --ip6-icmp-type</span><span style=color:#032F62> router-advertisement</span><span style=color:#005CC5> -j</span><span style=color:#032F62> ACCEPT</span></span>
<span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>ebtables</span><span style=color:#005CC5> -t</span><span style=color:#032F62> nat</span><span style=color:#005CC5> -A</span><span style=color:#032F62> PREROUTING</span><span style=color:#005CC5> -p</span><span style=color:#032F62> IPv6</span><span style=color:#005CC5> --logical-in</span><span style=color:#032F62> br-lan</span><span style=color:#005CC5> --ip6-proto</span><span style=color:#032F62> ipv6-icmp</span><span style=color:#005CC5> --ip6-icmp-type</span><span style=color:#032F62> neighbour-solicitation</span><span style=color:#005CC5> -j</span><span style=color:#032F62> ACCEPT</span></span>
<span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>ebtables</span><span style=color:#005CC5> -t</span><span style=color:#032F62> nat</span><span style=color:#005CC5> -A</span><span style=color:#032F62> PREROUTING</span><span style=color:#005CC5> -p</span><span style=color:#032F62> IPv6</span><span style=color:#005CC5> --logical-in</span><span style=color:#032F62> br-lan</span><span style=color:#005CC5> --ip6-proto</span><span style=color:#032F62> ipv6-icmp</span><span style=color:#005CC5> --ip6-icmp-type</span><span style=color:#032F62> neighbour-advertisement</span><span style=color:#005CC5> -j</span><span style=color:#032F62> ACCEPT</span></span>
<span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>ebtables</span><span style=color:#005CC5> -t</span><span style=color:#032F62> nat</span><span style=color:#005CC5> -A</span><span style=color:#032F62> PREROUTING</span><span style=color:#005CC5> -p</span><span style=color:#032F62> IPv6</span><span style=color:#005CC5> --logical-in</span><span style=color:#032F62> br-lan</span><span style=color:#005CC5> -j</span><span style=color:#032F62> redirect</span></span>
</code></pre></div><p>前四条规则跳过 ICMPv6 的 SLAAC 与 NDP 相关的包，让它们通过网桥，实现 SLAAC 与 NDP 的中继。最后一条规则在 <code>nat</code> 链上让进入 <code>br-lan</code> 的所有 IPv6 数据包（排除了 SLAAC 与 NDP，剩余的均为需要路由的数据流量）停止经过网桥，而是将它们的目标 MAC 地址改为 <code>br-lan</code> 的 MAC 地址，使得这些数据包在路由器上的 <code>br-lan</code> 接口上被收到。对于发往本机的包和从本机发出的包，这些规则没有影响。而对于原本目标非本机 IP 的数据包，在被本机收到后，会被三层路由机制进行转发，由于被转发的两个网络地址范围均在 <code>br-lan</code> 上，所以包会再次从 <code>br-lan</code> 发出，经过网桥的 MAC 表，自动发往正确的接口。这需要开启 IPv6 转发，并允许 <code>br-lan</code> 到 <code>br-lan</code> 的转发：</p><div class=flex-wrapper><pre><code class=language-bash-prompt><span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>sysctl</span><span style=color:#005CC5> -w</span><span style=color:#032F62> net.ipv6.conf.all.forwarding=</span><span style=color:#005CC5>1</span></span>
<span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>ip6tables</span><span style=color:#005CC5> -t</span><span style=color:#032F62> filter</span><span style=color:#005CC5> -A</span><span style=color:#032F62> FORWARD</span><span style=color:#005CC5> -i</span><span style=color:#032F62> br-lan</span><span style=color:#005CC5> -o</span><span style=color:#032F62> br-lan</span><span style=color:#005CC5> -j</span><span style=color:#032F62> ACCEPT</span></span>
</code></pre></div><p>此时使用 <code>ip route</code> 配置额外的 IPv6 路由，它们会对来自 LAN 与 WAN 的流量生效。<br>同理 <code>ip6tables</code> 的防火墙规则也会生效。如果需要在防火墙中判断连接来自 WAN 或 LAN，可以使用 <code>physdev</code> 模块：</p><div class=flex-wrapper><pre><code class=language-bash-prompt><span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>ip6tables</span><span style=color:#005CC5> -t</span><span style=color:#032F62> fitler</span><span style=color:#005CC5> -A</span><span style=color:#032F62> FORWARD</span><span style=color:#005CC5> \</span></span>
<span class=line><span style=color:#005CC5>            -i</span><span style=color:#032F62> br-lan</span><span style=color:#005CC5> -o</span><span style=color:#032F62> br-lan</span><span style=color:#005CC5> \</span></span>
<span class=line><span style=color:#005CC5>            -m</span><span style=color:#032F62> physdev</span><span style=color:#005CC5> --physdev-in</span><span style=color:#032F62> wan</span><span style=color:#005CC5> \</span></span>
<span class=line><span style=color:#005CC5>            -p</span><span style=color:#032F62> tcp</span><span style=color:#005CC5> --dport</span><span style=color:#005CC5> 80</span><span style=color:#005CC5> \</span></span>
<span class=line><span style=color:#005CC5>            -j</span><span style=color:#032F62> DROP</span></span>
<span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6A737D># 注意此处不要使用 `--physdev-out lan`，因为 `--physdev-out` 有不同的含义</span></span>
</code></pre></div><p>即可将从 WAN 进入的目标端口为 TCP 80 的流量全部阻止，使得 WAN 中的主机无法访问 LAN 中主机的 TCP 80 端口。</p></div></div><nav class=post-pagination><a class=newer-posts href=../thanos-low-cost-metrics-on-homelab/ >上一篇<br>使用 Thanos 低成本构建存储于 Homelab 上的多服务 Prometheus 监控 </a><span class=page-number></span> <a class=older-posts href=../luks-with-tpm2-secure-boot/ >下一篇<br>基于 TPM 2.0 与 Secure Boot 的 LUKS 自动解密</a></nav><div class=post-comment-wrapper-giscus><div class=giscus></div></div></div></div><div class=single-column-footer>Powered by <a href=https://hexo.io/ target=_blank rel="noreferrer noopener">Hexo</a><br>Theme <a href=https://github.com/Menci/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal</a> by <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a><br>&copy; 2024 <a href=https://blog.men.ci>Menci<i class=material-icons>favorite</i></a></div></div></div><script src=//cdnjs.baoshuo.ren/ajax/libs/jquery/3.3.1/jquery.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/popper.js/1.14.4/umd/popper.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/vue/2.5.17/vue.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/smooth-scroll/14.2.1/smooth-scroll.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js crossorigin=anonymous></script><script src=//static.cdn.menci.xyz/menci-blog/js/journal.bde01167.min.js crossorigin=anonymous></script><script src=//giscus.api.menci.xyz/client.js data-repo=Menci/blog data-repo-id=R_kgDOGsK5nA data-category=Comments data-category-id=DIC_kwDOGsK5nM4CAulO data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-theme=menci-blog data-lang=zh-CN async></script><script>"serviceWorker"in navigator&&window.addEventListener("load",(function(){navigator.serviceWorker.register("/sw.js?t=https%3A%2F%2Fstatic.cdn.menci.xyz%2Fmenci-blog%2F")}));</script></body></html>