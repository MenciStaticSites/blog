<!doctype html><html lang=zh-CN><head><title>使用 Proxmox Backup Server 备份 Proxmox VE 的客户机与宿主机 - Menci&#39;s Blog</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=author content=Menci><meta name=description content="Proxmox VE 是一款功能强大且易于使用的虚拟化平台。在不依赖其它服务的情况下，Proxmox VE 即可设..."><meta name=keywords content=""><link rel=alternate type=application/atom+xml title="ATOM 1.0" href=/atom.xml><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=renderer content=webkit><meta name=theme-color content=#ffffff><link rel="shortcut icon" type=image/x-icon href=//static.cdn.menci.xyz/menci-blog/avatar.6e993e78.png crossorigin=anonymous><link rel=stylesheet href=//cdnjs.baoshuo.ren/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css crossorigin=anonymous><link rel=stylesheet href=//cdnjs.baoshuo.ren/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css crossorigin=anonymous><link rel=stylesheet href=//cdnjs.baoshuo.ren/ajax/libs/KaTeX/0.15.2/katex.min.css crossorigin=anonymous><link rel=stylesheet href=//static.cdn.menci.xyz/menci-blog/css/journal.b205a034.css crossorigin=anonymous><link rel=stylesheet href="//cdn.menci.xyz/fonts/css2?family=Noto+Sans+SC:wght@300%3B400%3B600&family=Source+Sans+Pro:wght@400%3B600&family=Lato:wght@400%3B500&family=Hind+Vadodara:wght@300%3B400&family=Montserrat&family=Fira+Code&family=Material+Icons&display=block" crossorigin=anonymous><script async data-domain=blog.men.ci src=//stat.u.sb/js/plausible.js></script><meta name=generator content="Hexo 7.3.0"></head><body><div id=top></div><div id=app><div class=single-column-drawer-container ref=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block false drawer-menu-item" href=https://blog.men.ci>首页 </a><a class="a-block false drawer-menu-item" href=/archives/ >归档 </a><a class="a-block false drawer-menu-item" href=/tags/ >标签 </a><a class="a-block false drawer-menu-item" href=/friends/ >朋友们 </a><a class="a-block false drawer-menu-item" href=/about-me/ >关于我</a></div></div></div><transition name=fade><div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav ref=navBar class="navbar navbar-light single-column-nav-container sticky-top"><div ref=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer><i class=material-icons>menu</i></button> <a ref=navTitle class=navbar-brand href=/ >Menci&#39;s Blog</a></div></nav><div class=single-column-header-container ref=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=/ ><div class=single-column-header-title>Menci's Blog</div><div class=single-column-header-subtitle>念念不忘，必有回响</div></a></div><div ref=sideContainer class=side-container><a class="a-block false nav-head" href=/ ><div class=nav-title>Menci's Blog</div><div class=nav-subtitle>念念不忘，必有回响</div></a><div class=nav-link-list><a class="a-block false nav-link-item" href=/archives/ >归档 </a><a class="a-block false nav-link-item" href=/tags/ >标签 </a><a class="a-block false nav-link-item" href=/friends/ >朋友们 </a><a class="a-block false nav-link-item" href=/about-me/ >关于我</a></div><div class=nav-footer>Powered by <a href=https://hexo.io/ target=_blank rel="noreferrer noopener">Hexo</a><br>Theme <a href=https://github.com/Menci/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal</a> by <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a><br>&copy; 2024 <a href=https://blog.men.ci>Menci<i class=material-icons>favorite</i></a></div></div><div ref=extraContainer class=extra-container><div class=pagination><a id=globalBackToTop class="animated-visibility pagination-action" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a></div></div><div ref=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper style="background-image: url('//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/banner.96ffe5e2.svg')"><div class=post-title>使用 Proxmox Backup Server 备份 Proxmox VE 的客户机与宿主机<div class=post-meta><time datetime=2022-11-11T18:43:00.000Z itemprop=datePublished>2022-11-12 </time>&nbsp; <i class=material-icons style="">label</i> <a href=/tags/Homelab/ >Homelab</a>, <a href=/tags/Proxmox/ >Proxmox</a>, <a href=/tags/SRE/ >SRE</a>, <a href=/tags/虚拟化/ >虚拟化</a>, <a href=/tags/备份/ >备份</a></div></div></div><div class=post-body-wrapper><div class=post-body><ol class=toc><li class="toc-item toc-level-1"><a class=toc-link href=#%E5%AE%89%E8%A3%85><span class=toc-number>1.</span> <span class=toc-text>安装</span></a></li><li class="toc-item toc-level-1"><a class=toc-link href=#%E9%85%8D%E7%BD%AE><span class=toc-number>2.</span> <span class=toc-text>配置</span></a><ol class=toc-child><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8><span class=toc-number>2.1.</span> <span class=toc-text>数据存储</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4><span class=toc-number>2.1.1.</span> <span class=toc-text>命名空间</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E7%94%A8%E6%88%B7%E4%B8%8E%E6%9D%83%E9%99%90><span class=toc-number>2.2.</span> <span class=toc-text>用户与权限</span></a></li></ol></li><li class="toc-item toc-level-1"><a class=toc-link href=#%E5%A4%87%E4%BB%BD><span class=toc-number>3.</span> <span class=toc-text>备份</span></a><ol class=toc-child><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%B7%BB%E5%8A%A0%E5%AD%98%E5%82%A8><span class=toc-number>3.1.</span> <span class=toc-text>添加存储</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E8%AE%BE%E7%BD%AE%E5%A4%87%E4%BB%BD%E4%BB%BB%E5%8A%A1><span class=toc-number>3.2.</span> <span class=toc-text>设置备份任务</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%A4%87%E4%BB%BD-proxmox-ve-%E5%AE%BF%E4%B8%BB%E6%9C%BA%EF%BC%88%E6%88%96%E4%BB%BB%E6%84%8F%E7%89%A9%E7%90%86%E6%9C%BA%EF%BC%89><span class=toc-number>3.3.</span> <span class=toc-text>备份 Proxmox VE 宿主机（或任意物理机）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class=toc-link href=#%E8%BF%9C%E7%A8%8B%E5%90%8C%E6%AD%A5><span class=toc-number>4.</span> <span class=toc-text>远程同步</span></a></li><li class="toc-item toc-level-1"><a class=toc-link href=#%E5%B7%B2%E7%9F%A5%E9%97%AE%E9%A2%98><span class=toc-number>5.</span> <span class=toc-text>已知问题</span></a><ol class=toc-child><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%A4%87%E4%BB%BD%E6%89%80%E6%9C%89%E6%9D%83%E9%94%99%E8%AF%AF><span class=toc-number>5.1.</span> <span class=toc-text>备份所有权错误</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E8%99%9A%E6%8B%9F%E6%9C%BA-i/o-%E6%9C%AA%E5%93%8D%E5%BA%94><span class=toc-number>5.2.</span> <span class=toc-text>虚拟机 I&#x2F;O 未响应</span></a></li></ol></li></ol><p>Proxmox VE 是一款功能强大且易于使用的虚拟化平台。在不依赖其它服务的情况下，Proxmox VE 即可设置灵活的备份策略，将客户机按时备份储存到指定的存储中。但 Proxmox VE 的一般备份方式不支持增量备份，也不支持备份宿主机本身。</p><p>本篇文章将介绍 Proxmox Backup Server 的安装与使用，它为 Proxmox VE 提供了增量备份、远程同步等高级功能。</p><span id=more></span><h1 id=%E5%AE%89%E8%A3%85 tabindex=-1>安装 <a class=headerlink href=#%E5%AE%89%E8%A3%85></a></h1><p>由于 Proxmox Backup Server 一般与 Proxmox VE 配合使用，我们将 Proxmox Backup Server 作为虚拟机安装在 Proxmox VE 环境中，官方提供的安装方式是使用 ISO 镜像安装，适用于 KVM 虚拟机，跟随图形界面安装程序安装即可。不建议将 Proxmox Backup Server 安装在单独的物理机器上，一方面，Proxmox Backup Server 对 CPU 与内存的占用并不大，使用单独的物理机会造成浪费；另一方面，即使在同一内网中，网络可能会成为备份数据传输的瓶颈。较为轻量化的安装方式是使用 LXC 容器。</p><p>截止本文发布之时，Proxmox Backup Server 的最新版本为 2.2，基于 Debian 11。</p><p>首先创建一个 Debian 11 的 LXC 容器（不需要 Privileged），并为其设置 <code>root</code> 密码（Proxmox Backup Server 需要在 Web 管理界面上使用 <code>root</code> 密码登录）。登录到容器内，为其设置时区（定时任务会根据当前时区运行）：</p><div class=flex-wrapper><pre><code class=language-bash-prompt><span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>rm</span><span style=color:#032F62> /etc/localtime</span></span>
<span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>ln</span><span style=color:#005CC5> -sf</span><span style=color:#032F62> /usr/share/zoneinfo/Asia/Shanghai</span><span style=color:#032F62> /etc/localtime</span></span>
</code></pre></div><p>在 Debian 源的基础上，添加 Proxmox Backup Server 的软件源：</p><div class=flex-wrapper><pre><code class=language-bash-prompt><span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>nano</span><span style=color:#032F62> /etc/apt/sources.list.d/pbs-enterprise.list</span></span>
</code></pre></div><p>任选一个镜像源即可：</p><div class=flex-wrapper><pre><code class=language-debsources><span class=line><span style=color:#D73A49>deb</span><span style=color:#032F62> http://mirrors.ustc.edu.cn/proxmox/debian/pbs</span><span style=color:#24292E> bullseye pbs-</span><span style=color:#6F42C1>no</span><span style=color:#24292E>-subscription</span></span>
<span class=line><span style=color:#D73A49>deb</span><span style=color:#032F62> http://mirrors.tuna.tsinghua.edu.cn/proxmox/pbs</span><span style=color:#24292E> bullseye pbs-</span><span style=color:#6F42C1>no</span><span style=color:#24292E>-subscription</span></span>
<span class=line><span style=color:#D73A49>deb</span><span style=color:#032F62> http://mirrors.xtom.hk/proxmox/debian/pbs</span><span style=color:#24292E> bullseye pbs-</span><span style=color:#6F42C1>no</span><span style=color:#24292E>-subscription</span></span>
<span class=line></span></code></pre></div><p>之后添加 Proxmox 的 GPG Key，并使用 APT 安装 <code>proxmox-backup-server</code> 包：</p><div class=flex-wrapper><pre><code class=language-bash-prompt><span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>wget</span><span style=color:#032F62> https://enterprise.proxmox.com/debian/proxmox-release-bullseye.gpg</span><span style=color:#005CC5> -O</span><span style=color:#032F62> /etc/apt/trusted.gpg.d/proxmox-release-bullseye.gpg</span></span>
<span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>apt</span><span style=color:#032F62> update</span><span style=color:#24292E> &#x26;&#x26; </span><span style=color:#6F42C1>apt</span><span style=color:#032F62> install</span><span style=color:#032F62> proxmox-backup-server</span></span>
</code></pre></div><p>如果 <code>ifupdown2</code> 包配置出错，可以忽略并重启后使用 <code>apt -f install</code> 修复。</p><p>安装结束后，登录 <code class=punctuation-r>https://IP:8007</code>（注意，与 Proxmox VE 的 8006 端口不同，Proxmox Backup Server 使用 8007 端口），使用创建 LXC 容器时的 <code>root</code> 密码登录，即可进入 Proxmox Backup Server 的管理界面。</p><p>注意，ISO 镜像中的图形化安装程序会设置管理员邮箱，但手动安装时不会询问。如果需要邮件通知，请在安装之后需要手动再管理界面中设置管理员邮箱（左侧菜单中选择「Configuraion → Access Control」，双击右侧的 <code>root</code> 用户）：</p><div class=images><div class=image><a href=//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/set-admin-email@1.4bb1a70e.333x.svg title="为 Proxmox Backup Server 设置管理员邮箱" data-fancybox><img src=//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/set-admin-email@1.4bb1a70e.333x.svg alt=编辑管理员用户 title="为 Proxmox Backup Server 设置管理员邮箱" srcset="//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/set-admin-email@1.4bb1a70e.333x.svg 1.333x" crossorigin=anonymous></a><p class=image-caption>为 Proxmox Backup Server 设置管理员邮箱</p></div></div><p>最后可以手动禁用 <code>systemd</code> 中不需要的 failed 服务：</p><div class=flex-wrapper><pre><code class=language-bash-prompt><span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>systemctl</span><span style=color:#032F62> disable</span><span style=color:#032F62> zfs-mount.service</span><span style=color:#032F62> zfs-share.service</span><span style=color:#032F62> zfs-zed.service</span><span style=color:#032F62> systemd-modules-load.service</span></span>
</code></pre></div><h1 id=%E9%85%8D%E7%BD%AE tabindex=-1>配置 <a class=headerlink href=#%E9%85%8D%E7%BD%AE></a></h1><h2 id=%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8 tabindex=-1>数据存储 <a class=headerlink href=#%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8></a></h2><p>在 Proxmox Backup Server 中，备份被存储在数据存储（Datastore）中，每个数据存储对应文件系统上的一个文件夹。备份文件被以 Proxmox Backup Server 的自有格式组织在文件系统上，数据以分块的形式存储，对文件系统的性能要求（相对于直接存储压缩文档）较高，所以不建议使用远程存储（CIFS / NFS）作为数据存储，推荐使用本地硬盘。如果需要在 NAS 上储存备份数据，建议在 NAS 上安装 Proxmox Backup Server 虚拟机。</p><p>将需要存储数据的硬盘分区挂载到任意目录下（如 <code class=punctuation-r>/mnt/data</code>）。如果在 Proxmox VE 管理界面为 Proxmox Backup Server 客户机分配备份存储空间，请注意不要勾选备份（Backup）选项。如果需要在 LXC 容器中挂载远程 NFS 共享作为数据存储目录，请在宿主机中为其开启 NFS 支持。对于 KVM，可以将备份硬盘直通给虚拟机进行使用；对于 LXC，可以将备份硬盘挂载到宿主机上，并映射给 LXC 容器：</p><div class=flex-wrapper><pre><code class=language-bash-prompt><span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>pct</span><span style=color:#032F62> set</span><span style=color:#005CC5> 111</span><span style=color:#005CC5> -mp0</span><span style=color:#032F62> /mnt/hdd,mp=/mnt/data</span><span style=color:#6A737D> # 将宿主机的 /mnt/hdd 映射到 LXC 容器 111 的客户机 /mnt/data 路径中</span></span>
</code></pre></div><p>对于 Unprivileged 容器，会遇到容器中无法写入的问题，这是由于 LXC 将容器内的 UID/GID 映射到了宿主机上的其他 UID/GID。可以在宿主机上检查容器内 <code>root</code> 用户/用户组所对应的 UID/GID：</p><div class=flex-wrapper><pre><code class=language-bash-prompt><span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#005CC5>stat</span><span style=color:#005CC5> -c</span><span style=color:#032F62> "%u %g"</span><span style=color:#032F62> /proc/</span><span style=color:#24292E>$(</span><span style=color:#6F42C1>pgrep</span><span style=color:#005CC5> -f</span><span style=color:#032F62> proxmox-backup-api</span><span style=color:#24292E>)</span></span>
100000 100000
</code></pre></div><p>将宿主机上的数据目录的属主/属组改为上述命令输出的 UID/GID 即可：</p><div class=flex-wrapper><pre><code class=language-bash-prompt><span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>chown</span><span style=color:#032F62> 100000:100000</span><span style=color:#032F62> /mnt/hdd</span></span>
</code></pre></div><p>确保 Proxmox Backup Server 可以正确写入存储目录后，在管理界面上创建数据存储（左侧菜单中选择「Datastore → Add Datastore」）：</p><div class=images><div class=image><a href=//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/add-datastore@1.44f1611a.333x.svg title="添加 Datastore" data-fancybox><img src=//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/add-datastore@1.44f1611a.333x.svg alt="添加 Datastore" title="添加 Datastore" srcset="//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/add-datastore@1.44f1611a.333x.svg 1.333x" crossorigin=anonymous></a><p class=image-caption>添加 Datastore</p></div></div><p>右侧的 GC Schedule 和 Prune Schedule 分别表示进行垃圾回收与删除多余备份的定时任务时间，默认的 <code>daily</code> 表示每天 <code class=punctuation-r>00:00</code>。删除备份时的保留策略在第二个选项卡「Prune Options」中设置：</p><div class=images><div class=image><a href=//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/add-datastore-prune-options@1.1b0c841f.333x.svg title="设置 Datastore 的保留策略" data-fancybox><img src=//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/add-datastore-prune-options@1.1b0c841f.333x.svg alt="设置 Datastore 的保留策略" title="设置 Datastore 的保留策略" srcset="//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/add-datastore-prune-options@1.1b0c841f.333x.svg 1.333x" crossorigin=anonymous></a><p class=image-caption>设置 Datastore 的保留策略</p></div></div><p>如图所示，表示保留互相间隔一天的 7 个备份，互相间隔一周的 8 个备份，互相间隔一个月的 6 个备份。这些选项也可以在 Proxmox VE 的备份任务中设置，但更推荐在 Proxmox Backup Server 中设置。</p><p>点击「Add」提交后，系统将开始创建数据存储，由于需要对文件系统上的目录结构进行一些初始化，在 HDD 或远程存储上可能需要较长的时间。</p><h3 id=%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4 tabindex=-1>命名空间 <a class=headerlink href=#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4></a></h3><p>每个数据存储中可以包含多个命名空间，命名空间并不隔离访问权限与存储设备，仅隔离备份名称。每一组备份以 VM/CT 的 ID 或者宿主机的主机名来命名，在不同命名空间中放置来自不同 Proxmox VE 服务器的数据，可以确保名称不会冲突。</p><p>在 Datastore 的管理界面选择「Content」选项卡，并在下方列表的右上方点击「Add NS」按钮，即可创建命名空间。</p><h2 id=%E7%94%A8%E6%88%B7%E4%B8%8E%E6%9D%83%E9%99%90 tabindex=-1>用户与权限 <a class=headerlink href=#%E7%94%A8%E6%88%B7%E4%B8%8E%E6%9D%83%E9%99%90></a></h2><p>除仅用于登录管理界面的 <code>root</code> 用户使用 PAM 认证外，其他管理员用户或备份客户端均使用 Proxmox Backup Server 自带的用户管理系统进行认证。在左侧菜单中选择「Configuration → Access Control」，并点击右侧的「Add」按钮，输入用户名与密码：</p><div class=images><div class=image><a href=//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/add-user@1.2ee7d926.333x.svg title=添加用户 data-fancybox><img src=//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/add-user@1.2ee7d926.333x.svg alt=添加用户 title=添加用户 srcset="//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/add-user@1.2ee7d926.333x.svg 1.333x" crossorigin=anonymous></a><p class=image-caption>添加用户</p></div></div><p>如果该用户是另一位管理员用户，则可以输入其邮箱地址，之后可以将邮件通知设为发往其邮箱。如果是备份客户端用户，则不需要填写邮箱。</p><p>然后在「Permissions」选项卡中，点击「Add → User Permission」，为刚刚创建的用户添加权限：</p><div class=images><div class=image><a href=//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/add-user-permission@1.764ad0e1.333x.svg title=为用户授予权限 data-fancybox><img src=//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/add-user-permission@1.764ad0e1.333x.svg alt=为用户授予权限 title=为用户授予权限 srcset="//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/add-user-permission@1.764ad0e1.333x.svg 1.333x" crossorigin=anonymous></a><p class=image-caption>为用户授予权限</p></div></div><p>如果该用户是另一位管理员用户，可以选择为其授予根路径的管理员权限。如果用于 Proxmox VE 服务器上的备份客户端，并且希望在 Proxmox VE 上管理备份，可以选择在特定数据存储下的 <code>DatastoreAdmin</code> 权限。</p><h1 id=%E5%A4%87%E4%BB%BD tabindex=-1>备份 <a class=headerlink href=#%E5%A4%87%E4%BB%BD></a></h1><h2 id=%E6%B7%BB%E5%8A%A0%E5%AD%98%E5%82%A8 tabindex=-1>添加存储 <a class=headerlink href=#%E6%B7%BB%E5%8A%A0%E5%AD%98%E5%82%A8></a></h2><p>首先需要在 Proxmox VE 中将 Proxmox Backup Server 添加为存储（Storage）。登录 Proxmox VE 管理界面，选择「Datacenter → Storage」，在「Add」按钮的菜单中选择「Proxmox Backup Server」：</p><div class=images><div class=image><a href=//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/pve-add-pbs-storage@1.f61643b4.333x.svg title="在 Proxmox VE 中添加备份存储" data-fancybox><img src=//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/pve-add-pbs-storage@1.f61643b4.333x.svg alt="在 Proxmox VE 中添加备份存储" title="在 Proxmox VE 中添加备份存储" srcset="//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/pve-add-pbs-storage@1.f61643b4.333x.svg 1.333x" crossorigin=anonymous></a><p class=image-caption>在 Proxmox VE 中添加备份存储</p></div></div><p>在 Server 字段中填写 Proxmox Backup Server 的 IP 地址或域名。如果在特殊情况下，Proxmox Backup Server 位于 NAT 之后无法被主动连接，可以使用 <a target=_blank rel=noopener href=https://github.com/rapiz1/rathole>Rathole</a> 等内网穿透工具，这种时候可将 8007 端口转发到任意端口号，并在 Server 字段中填写 IP:PORT。对于 Username 字段，请注意在创建时输入的用户名后面加上 <code class=punctuation-r>@pbs</code>，表示是 Proxmox Backup Server 自己的账户系统（而非 PAM）。</p><p>建议对备份进行加密，在「Encryption」选项卡中选择第二项「Auto-generate a client encryption key」，自动生成客户端加密密钥。对备份进行加密可以确保服务器端无法访问备份数据的内容，特别是对于使用共享的 Proxmox Backup Server，或者为了冗余需要将备份同步到其他 Proxmox Backup Server 时。</p><div class=images><div class=image><a href=//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/pve-add-pbs-storage-encryption@1.ed45a51b.333x.svg title=为备份存储设置加密 data-fancybox><img src=//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/pve-add-pbs-storage-encryption@1.ed45a51b.333x.svg alt=为备份存储设置加密 title=为备份存储设置加密 srcset="//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/pve-add-pbs-storage-encryption@1.ed45a51b.333x.svg 1.333x" crossorigin=anonymous></a><p class=image-caption>为备份存储设置加密</p></div></div><p>点击「Add」按钮添加后，如果使用了默认的自签证书（未被 Proxmox VE 客户端所信任），会提示 SSL Fingerprint 不匹配，这时候复制错误文本中的 Fingerprint 文本，填写到「General」选项卡的对应字段中，即可添加成功。添加成功后，Proxmox VE 会提示你将自动生成的加密密钥保存。再次添加该存储并读取已有的备份时，需要选择「Upload an existing client encryption key」，将保存好的 Key 文件上传，即可解密之前的备份数据。</p><div class=images><div class=image><a href=//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/pve-add-pbs-storage-save-key@1.2bd59a86.333x.svg title=下载加密密钥 data-fancybox><img src=//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/pve-add-pbs-storage-save-key@1.2bd59a86.333x.svg alt=下载加密密钥 title=下载加密密钥 srcset="//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/pve-add-pbs-storage-save-key@1.2bd59a86.333x.svg 1.333x" crossorigin=anonymous></a><p class=image-caption>下载加密密钥</p></div></div><h2 id=%E8%AE%BE%E7%BD%AE%E5%A4%87%E4%BB%BD%E4%BB%BB%E5%8A%A1 tabindex=-1>设置备份任务 <a class=headerlink href=#%E8%AE%BE%E7%BD%AE%E5%A4%87%E4%BB%BD%E4%BB%BB%E5%8A%A1></a></h2><p>在 Proxmox VE 管理面板中，选择「Datacenter → Backup → Add」，指定需要备份的客户机列表与备份时间，选择 Storage 为刚刚添加的 Proxmox Backup Server，即可创建备份任务。</p><p>创建备份任务后，可以在列表中选中任务点击「Run now」，测试备份任务是否可以正常工作。</p><h2 id=%E5%A4%87%E4%BB%BD-proxmox-ve-%E5%AE%BF%E4%B8%BB%E6%9C%BA%EF%BC%88%E6%88%96%E4%BB%BB%E6%84%8F%E7%89%A9%E7%90%86%E6%9C%BA%EF%BC%89 tabindex=-1>备份 Proxmox VE 宿主机（或任意物理机） <a class=headerlink href=#%E5%A4%87%E4%BB%BD-proxmox-ve-%E5%AE%BF%E4%B8%BB%E6%9C%BA%EF%BC%88%E6%88%96%E4%BB%BB%E6%84%8F%E7%89%A9%E7%90%86%E6%9C%BA%EF%BC%89></a></h2><p>截至本文发布之时，Proxmox Backup Server 还没有完整支持对 Proxmox VE 宿主机的备份，我们暂时无法在管理界面中配置宿主机备份。但是该功能已存在于当前的版本中，可以通过手动调用 <code>proxmox-backup-client</code> 来使用。参考<a target=_blank rel=noopener href=https://pbs.proxmox.com/docs/command-syntax.html#proxmox-backup-client>官方文档</a>，使用 <code>--backup-type host</code> 参数可以创建宿主机备份。</p><p>对于使用 LVM 安装的 Proxmox VE，我们可以编写一个脚本，首先对 Proxmox VE 的宿主机根分区创建一个 LVM 快照（宿主机的写入量不大，快照的大小只需要能满足备份期间宿主机写入量即可，所以快照不需要太大），然后调用 <code>proxmox-backup-client</code> 对快照块设备进行备份，最后删除快照：</p><div class=flex-wrapper><pre><code class=language-bash><span class=line><span style=color:#6A737D>#!/bin/bash</span></span>
<span class=line><span style=color:#6F42C1>lvremove</span><span style=color:#005CC5> -y</span><span style=color:#032F62> pve/root_snapshot</span><span style=color:#D73A49> ||</span><span style=color:#005CC5> true</span></span>
<span class=line><span style=color:#6F42C1>lvcreate</span><span style=color:#005CC5> -pr</span><span style=color:#005CC5> -L</span><span style=color:#032F62> 5G</span><span style=color:#005CC5> --monitor</span><span style=color:#032F62> y</span><span style=color:#005CC5> --snapshot</span><span style=color:#005CC5> --name</span><span style=color:#032F62> root_snapshot</span><span style=color:#032F62> pve/root</span></span>
<span class=line></span>
<span class=line><span style=color:#D73A49>export</span><span style=color:#24292E> PBS_PASSWORD_FILE</span><span style=color:#D73A49>=</span><span style=color:#24292E>/etc/pve/priv/storage/menci-pbs-home.pw</span></span>
<span class=line><span style=color:#6F42C1>proxmox-backup-client</span><span style=color:#032F62> backup</span><span style=color:#032F62> root.img:/dev/pve/root_snapshot</span><span style=color:#005CC5> --backup-type</span><span style=color:#032F62> host</span><span style=color:#005CC5> --repository</span><span style=color:#032F62> Menci-Home@pbs@192.168.1.12:HDD</span><span style=color:#005CC5> --ns</span><span style=color:#032F62> Home</span><span style=color:#005CC5> --keyfile</span><span style=color:#032F62> /etc/pve/priv/storage/menci-pbs-home.enc</span></span>
<span class=line></span>
<span class=line><span style=color:#6F42C1>lvremove</span><span style=color:#005CC5> -y</span><span style=color:#032F62> pve/root_snapshot</span></span>
<span class=line></span></code></pre></div><p>上述命令中，<code class=punctuation-l>--repository</code> 表示备份目标存储，格式为 <code class=punctuation-r>&lt;username&gt;@pbs@&lt;host:port&gt;:&lt;datastore&gt;</code>，命名空间通过 <code>--ns</code> 参数指定。密码和加密密钥通过文件指定，对于在 Proxmox VE 管理面板添加过的存储，对应的文件即为 <code>/etc/pve/priv/storage/</code> 目录下的 <code>.pw</code> 与 <code>.enc</code> 文件。</p><p>该命令中的 <code>root.img:/dev/pve/root_snapshot</code> 部分可以指定多次，用于备份多个磁盘分区。前半部分为生成的备份中的文件名，后半部分为文件系统中的源文件（或目录）的路径。如果后半部分是一个路径，则前半部分需要是 <code>.pxar</code> 格式的文件名，表示将文件夹打包为 Proxmox Backup Server 的 <a target=_blank rel=noopener href=https://pbs.proxmox.com/docs/file-formats.html>Proxmox File Archive Format</a> 格式，可以使用对应的<a target=_blank rel=noopener href=https://pbs.proxmox.com/docs/pxar-tool.html>命令行工具</a>进行处理。</p><p>对于使用 ZFS 安装的 Proxmox VE，其根文件系统是一个 ZFS dataset（默认位于 <code class=punctuation-r>/rpool/ROOT/pve-1</code>），我们可以为其创建快照。ZFS 快照可以被挂载为一个只读目录，可以使用 <code>.pxar</code> 格式对快照目录进行备份即可：</p><div class=flex-wrapper><blockquote><p>ZFS 快照目录默认可能是隐藏的，需要先执行 <code>zfs set snapdir=visible rpool/ROOT/pve-1</code> 将其设为可见。</p></blockquote></div><div class=flex-wrapper><pre><code class=language-bash><span class=line><span style=color:#6A737D>#!/bin/bash</span></span>
<span class=line><span style=color:#6F42C1>zfs</span><span style=color:#032F62> destroy</span><span style=color:#032F62> rpool/ROOT/pve-1@backup</span><span style=color:#D73A49> ||</span><span style=color:#005CC5> true</span></span>
<span class=line><span style=color:#6F42C1>zfs</span><span style=color:#032F62> snapshot</span><span style=color:#032F62> rpool/ROOT/pve-1@backup</span></span>
<span class=line></span>
<span class=line><span style=color:#D73A49>export</span><span style=color:#24292E> PBS_PASSWORD_FILE</span><span style=color:#D73A49>=</span><span style=color:#24292E>/etc/pve/priv/storage/menci-pbs-home.pw</span></span>
<span class=line><span style=color:#6F42C1>proxmox-backup-client</span><span style=color:#032F62> backup</span><span style=color:#032F62> root.pxar:/.zfs/snapshot/backup</span><span style=color:#005CC5> --backup-type</span><span style=color:#032F62> host</span><span style=color:#005CC5> --repository</span><span style=color:#032F62> Menci-Home@pbs@menci-pbs.home.net.men.ci:HDD</span><span style=color:#005CC5> --ns</span><span style=color:#032F62> Home</span><span style=color:#005CC5> --keyfile</span><span style=color:#032F62> /etc/pve/priv/storage/menci-pbs-home.enc</span></span>
<span class=line></span>
<span class=line><span style=color:#6F42C1>zfs</span><span style=color:#032F62> destroy</span><span style=color:#032F62> rpool/ROOT/pve-1@backup</span></span>
<span class=line></span></code></pre></div><p>将编写好的备份脚本保存，例如保存到 <code class=punctuation-r>/root/backup-host.sh</code>。为其添加执行权限，并加入到 <code>cron</code> 中定时执行（注意添加 <code>PATH</code> 行，否则 <code>cron</code> 定时任务执行时的 <code>PATH</code> 不完整会导致执行失败）：</p><div class=flex-wrapper><pre><code class=language-crontab><span class=line><span style=color:#24292E>PATH</span><span style=color:#D73A49>=</span><span style=color:#032F62>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span></span>
<span class=line><span style=color:#005CC5>0</span><span style=color:#005CC5> 3</span><span style=color:#005CC5> *</span><span style=color:#005CC5> *</span><span style=color:#005CC5> *</span><span style=color:#032F62> /root/backup-host.sh</span></span>
<span class=line></span></code></pre></div><p>当需要进行恢复时，使用同样在命令行下使用 <code>proxmox-backup-client</code> 工具进行恢复：</p><div class=flex-wrapper><pre><code class=language-bash-prompt><span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>proxmox-backup-client</span><span style=color:#032F62> restore</span><span style=color:#032F62> host/Menci-PVE</span><span style=color:#032F62> root.img</span><span style=color:#032F62> restored_root.img</span><span style=color:#005CC5> --repository</span><span style=color:#032F62> Menci-Home@pbs@192.168.1.12:HDD</span><span style=color:#005CC5> --ns</span><span style=color:#032F62> Home</span><span style=color:#005CC5> --keyfile</span><span style=color:#032F62> /etc/pve/priv/storage/menci-pbs-home.enc</span></span>
</code></pre></div><p>上述命令表示，从该备份存储中，恢复 <code class=punctuation-r>host/Menci-PVE</code>（格式为 <code class=punctuation-r>host/&lt;hostname&gt;</code>，可在 Web 管理界面中看到这些备份）中的 <code>root.img</code> 文件，下载到本地的 <code>restored_root.img</code> 文件中。</p><p>除备份 Proxmox VE 宿主机外，<code class=punctuation-l>proxmox-backup-client</code> 命令行工具也可以在其他任何 Linux 机器上运行，官方提供了该工具的 <a target=_blank rel=noopener href=https://pbs.proxmox.com/docs/installation.html#proxmox-backup-client-only-repository>APT 源</a>。理论上来说，任何支持快照的文件系统均可使用该工具进行备份。</p><h1 id=%E8%BF%9C%E7%A8%8B%E5%90%8C%E6%AD%A5 tabindex=-1>远程同步 <a class=headerlink href=#%E8%BF%9C%E7%A8%8B%E5%90%8C%E6%AD%A5></a></h1><p>Proxmox Backup Server 支持在多个服务器之间将备份进行同步，具体的实现方式是，原本的备份数据存放在 A 服务器上，B 服务器定时连接 A 服务器拉取备份。注意这里只能由 B（需同步到的目标服务器）主动连接 A（存放原始备份的源服务器），如果 A 在 NAT 之后无法由 B 主动连接，可以使用上述添加存储时一样的解决方案，使用 <a target=_blank rel=noopener href=https://github.com/rapiz1/rathole>Rathole</a> 等内网穿透工具进行端口映射。</p><p>与进行备份时一样，进行同步时，B 服务器也需要使用用户和密码登录到 A 服务器。按照上述方法在 A 服务器上创建用户，仅需授予 <code>DatastoreReader</code> 权限。同步备份无需客户端密钥，因为 Proxmox VE 在备份客户端所进行的加密，对 Proxmox Backup Server 是透明的，同步时也无需解密。所以，如果之后要从 B 服务器上恢复备份，同样需要连接 A 服务器时的密钥。</p><p>在 B 服务器上选择左侧菜单中的「Configuration → Remotes」，点击右侧的「Add」按钮，添加 A 服务器（按照同样的方式填写 Fingerprint）：</p><div class=images><div class=image><a href=//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/sync-add-remote@1.770c5e2a.333x.svg title=添加远程服务器 data-fancybox><img src=//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/sync-add-remote@1.770c5e2a.333x.svg alt=添加远程服务器 title=添加远程服务器 srcset="//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/sync-add-remote@1.770c5e2a.333x.svg 1.333x" crossorigin=anonymous></a><p class=image-caption>添加远程服务器</p></div></div><p>之后在 B 服务器上创建一个数据存储，并创建对应的命名空间（如果需要）。在创建好的数据存储中选择「Sync Jobs」选项卡，点击「Add」按钮：</p><div class=images><div class=image><a href=//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/sync-add-job@1.837a0a38.333x.svg title=添加拉取任务 data-fancybox><img src=//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/sync-add-job@1.837a0a38.333x.svg alt=添加拉取任务 title=添加拉取任务 srcset="//static.cdn.menci.xyz/menci-blog/backup-pve-with-pbs/sync-add-job@1.837a0a38.333x.svg 1.333x" crossorigin=anonymous></a><p class=image-caption>添加拉取任务</p></div></div><p>指定从源 A 服务器的某个数据存储的某个命名空间，同步到当前 B 服务器的某个数据存储的某个命名空间，并填写计划时间。如果传输在公网上进行，建议设置带宽限制，以免影响双方（特别是上传方）的其他网络应用。可以勾选「Remove vanished」选项以自动删除在原服务器 A 上已删除的备份，或者在 B 服务器上为数据存储设置保留策略。</p><p>创建完成后可以点击「Run now」测试同步是否可以正常工作。</p><h1 id=%E5%B7%B2%E7%9F%A5%E9%97%AE%E9%A2%98 tabindex=-1>已知问题 <a class=headerlink href=#%E5%B7%B2%E7%9F%A5%E9%97%AE%E9%A2%98></a></h1><h2 id=%E5%A4%87%E4%BB%BD%E6%89%80%E6%9C%89%E6%9D%83%E9%94%99%E8%AF%AF tabindex=-1>备份所有权错误 <a class=headerlink href=#%E5%A4%87%E4%BB%BD%E6%89%80%E6%9C%89%E6%9D%83%E9%94%99%E8%AF%AF></a></h2><p>类似 Linux 的文件系统权限管理，Proxmox Backup Server 会记录每个备份组是由哪个用户所创建的。例如，如果用户 A 连接到服务器创建了一个 <code class=punctuation-r>vm/101</code>（ID 为 101 的 KVM 虚拟机）的备份，则以用户 B 连接时，无法在同一命名空间创建再次创建名为 <code>vm/101</code> 的另一个备份。</p><p>即使删除掉已有的 <code>vm/101</code> 下的所有备份，所有权仍然不会消除。如果需要使用另一个用户创建同名的备份，请使用命令手动修改所有权。登录任意具有 <code>DatastoreAdmin</code> 权限的用户即可更改所有权。</p><div class=flex-wrapper><pre><code class=language-bash-prompt><span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>proxmox-backup-client</span><span style=color:#032F62> change-owner</span><span style=color:#032F62> vm/101</span><span style=color:#032F62> New-User@pbs</span><span style=color:#005CC5> --repository</span><span style=color:#032F62> Any-User@pbs@192.168.1.12:HDD</span><span style=color:#005CC5> --ns</span><span style=color:#032F62> Home</span></span>
</code></pre></div><p>在 Web 管理界面上可以看到每个备份组的所有者，但暂时无法进行修改。目前仅支持使用上述命令修改所有权。</p><h2 id=%E8%99%9A%E6%8B%9F%E6%9C%BA-i%2Fo-%E6%9C%AA%E5%93%8D%E5%BA%94 tabindex=-1>虚拟机 I/O 未响应 <a class=headerlink href=#%E8%99%9A%E6%8B%9F%E6%9C%BA-i%2Fo-%E6%9C%AA%E5%93%8D%E5%BA%94></a></h2><p>Proxmox VE 传统的 <code>vzdump</code> 备份统一采用 LVM / ZFS 快照来捕捉客户机（KVM 虚拟机和 LXC 容器）的一致性的文件系统，不会影响客户机的运行。向 Proxmox Backup Server 备份时，Proxmox VE 对 LVM 采用同样的方式进行，并采用对两次快照进行对比的方式实现增量（对宿主机备份也是如此），但对于 KVM 虚拟机，他们使用了另一种由 QEMU 提供的一致性增量备份接口：<a target=_blank rel=noopener href=https://qemu-project.gitlab.io/qemu/interop/bitmaps.html>Dirty Bitmaps</a>。</p><p>QEMU Dirty Bitmap 可以记录 KVM 虚拟机在虚拟磁盘设备的哪些位置进行了写入操作，并允许虚拟机管理程序仅将被修改的部分记录到备份中。在创建备份时，QEMU 在内存中进行一个快照，向虚拟机管理程序提供一致性的 Bitmap 和虚拟磁盘数据。但由于缺少类似 LVM 的 Copy on Write 机制，为了保证虚拟机能够正常运行不被中断，QEMU 只能将备份期间虚拟机进行的磁盘写入操作暂时缓存在内存中，待备份结束后再写回存储设备。</p><p>这导致了一个问题，如果单个虚拟机备份耗时较长，同时在这个时间内虚拟机进行了较多的磁盘写入操作，则 QEMU 内部的快照缓冲区会被占满，此时 QEMU 只能将接下来的写入操作完全阻塞，导致虚拟机无响应，造成服务中断。而如果该虚拟机位于 Proxmox VE 到 Proxmox Backup Server 的网络出口上（例如，向公网上的服务器备份，途中作为路由器/防火墙的虚拟机被阻塞），则备份过程会被阻塞，最终因连接中断而备份失败。</p><p>有用户曾经提出过使用 LVM / ZFS 快照进行 KVM 备份的<a target=_blank rel=noopener href="https://bugzilla.proxmox.com/show_bug.cgi?id=4136">建议</a>，但被官方驳回，官方更倾向于使用 QEMU 自带的增量备份机制。QEMU 在 <a target=_blank rel=noopener href=https://github.com/qemu/qemu/commit/af5bcd775f3115e4c1b7715920a67b31b119de30>7.0 中加入</a>了名为 Fleecing 的机制，可以利用磁盘作为备份快照的写入缓冲，以解决内存中的缓冲区不足的问题，但 Proxmox VE 还没有跟进支持。</p><p>目前针对此问题的建议是，不要直接从 Proxmox VE 向异地的 Proxmox Backup Server 发送备份，而是先备份到本地的 Proxmox Backup Server 中，确保单个虚拟机的备份过程不会持续太久，之后再同步到远程服务器上。</p></div></div><nav class=post-pagination><a class=newer-posts href=../luks-with-tpm2-secure-boot/ >上一篇<br>基于 TPM 2.0 与 Secure Boot 的 LUKS 自动解密 </a><span class=page-number></span> <a class=older-posts href=../ssl-with-github-actions/ >下一篇<br>使用 GitHub Actions 自动申请与部署 ACME SSL 证书</a></nav><div class=post-comment-wrapper-giscus><div class=giscus></div></div></div></div><div class=single-column-footer>Powered by <a href=https://hexo.io/ target=_blank rel="noreferrer noopener">Hexo</a><br>Theme <a href=https://github.com/Menci/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal</a> by <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a><br>&copy; 2024 <a href=https://blog.men.ci>Menci<i class=material-icons>favorite</i></a></div></div></div><script src=//cdnjs.baoshuo.ren/ajax/libs/jquery/3.3.1/jquery.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/popper.js/1.14.4/umd/popper.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/vue/2.5.17/vue.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/smooth-scroll/14.2.1/smooth-scroll.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js crossorigin=anonymous></script><script src=//static.cdn.menci.xyz/menci-blog/js/journal.bde01167.min.js crossorigin=anonymous></script><script src=//giscus.api.menci.xyz/client.js data-repo=Menci/blog data-repo-id=R_kgDOGsK5nA data-category=Comments data-category-id=DIC_kwDOGsK5nM4CAulO data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-theme=menci-blog data-lang=zh-CN async></script><script>"serviceWorker"in navigator&&window.addEventListener("load",(function(){navigator.serviceWorker.register("/sw.js?t=https%3A%2F%2Fstatic.cdn.menci.xyz%2Fmenci-blog%2F")}));</script></body></html>