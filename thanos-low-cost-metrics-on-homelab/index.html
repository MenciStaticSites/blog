<!doctype html><html lang=zh-CN><head><title>使用 Thanos 低成本构建存储于 Homelab 上的多服务 Prometheus 监控 - Menci&#39;s Blog</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=author content=Menci><meta name=description content="Prometheus 是很常用的服务指标监控系统。通过 Prometheus，我们将线上服务暴露的指标收集存储到时..."><meta name=keywords content=""><link rel=alternate type=application/atom+xml title="ATOM 1.0" href=/atom.xml><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=renderer content=webkit><meta name=theme-color content=#ffffff><link rel="shortcut icon" type=image/x-icon href=//static.cdn.menci.xyz/menci-blog/avatar.6e993e78.png crossorigin=anonymous><link rel=stylesheet href=//cdnjs.baoshuo.ren/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css crossorigin=anonymous><link rel=stylesheet href=//cdnjs.baoshuo.ren/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css crossorigin=anonymous><link rel=stylesheet href=//cdnjs.baoshuo.ren/ajax/libs/KaTeX/0.15.2/katex.min.css crossorigin=anonymous><link rel=stylesheet href=//static.cdn.menci.xyz/menci-blog/css/journal.b205a034.css crossorigin=anonymous><link rel=stylesheet href="//cdn.menci.xyz/fonts/css2?family=Noto+Sans+SC:wght@300%3B400%3B600&family=Source+Sans+Pro:wght@400%3B600&family=Lato:wght@400%3B500&family=Hind+Vadodara:wght@300%3B400&family=Montserrat&family=Fira+Code&family=Material+Icons&display=block" crossorigin=anonymous><script async data-domain=blog.men.ci src=//stat.u.sb/js/plausible.js></script><meta name=generator content="Hexo 7.3.0"></head><body><div id=top></div><div id=app><div class=single-column-drawer-container ref=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block false drawer-menu-item" href=https://blog.men.ci>首页 </a><a class="a-block false drawer-menu-item" href=/archives/ >归档 </a><a class="a-block false drawer-menu-item" href=/tags/ >标签 </a><a class="a-block false drawer-menu-item" href=/friends/ >朋友们 </a><a class="a-block false drawer-menu-item" href=/about-me/ >关于我</a></div></div></div><transition name=fade><div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav ref=navBar class="navbar navbar-light single-column-nav-container sticky-top"><div ref=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer><i class=material-icons>menu</i></button> <a ref=navTitle class=navbar-brand href=/ >Menci&#39;s Blog</a></div></nav><div class=single-column-header-container ref=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=/ ><div class=single-column-header-title>Menci's Blog</div><div class=single-column-header-subtitle>念念不忘，必有回响</div></a></div><div ref=sideContainer class=side-container><a class="a-block false nav-head" href=/ ><div class=nav-title>Menci's Blog</div><div class=nav-subtitle>念念不忘，必有回响</div></a><div class=nav-link-list><a class="a-block false nav-link-item" href=/archives/ >归档 </a><a class="a-block false nav-link-item" href=/tags/ >标签 </a><a class="a-block false nav-link-item" href=/friends/ >朋友们 </a><a class="a-block false nav-link-item" href=/about-me/ >关于我</a></div><div class=nav-footer>Powered by <a href=https://hexo.io/ target=_blank rel="noreferrer noopener">Hexo</a><br>Theme <a href=https://github.com/Menci/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal</a> by <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a><br>&copy; 2024 <a href=https://blog.men.ci>Menci<i class=material-icons>favorite</i></a></div></div><div ref=extraContainer class=extra-container><div class=pagination><a id=globalBackToTop class="animated-visibility pagination-action" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a></div></div><div ref=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper style="background-image: url('//static.cdn.menci.xyz/menci-blog/thanos-low-cost-metrics-on-homelab/banner.12da5bb3.svg')"><div class=post-title>使用 Thanos 低成本构建存储于 Homelab 上的多服务 Prometheus 监控<div class=post-meta><time datetime=2024-02-16T16:00:00.000Z itemprop=datePublished>2024-02-17 </time>&nbsp; <i class=material-icons style="">label</i> <a href=/tags/Homelab/ >Homelab</a>, <a href=/tags/SRE/ >SRE</a>, <a href=/tags/Metrics/ >Metrics</a>, <a href=/tags/Thanos/ >Thanos</a>, <a href=/tags/Prometheus/ >Prometheus</a></div></div></div><div class=post-body-wrapper><div class=post-body><ol class=toc><li class="toc-item toc-level-1"><a class=toc-link href=#%E4%BB%8B%E7%BB%8D><span class=toc-number>1.</span> <span class=toc-text>介绍</span></a></li><li class="toc-item toc-level-1"><a class=toc-link href=#%E9%83%A8%E7%BD%B2><span class=toc-number>2.</span> <span class=toc-text>部署</span></a><ol class=toc-child><li class="toc-item toc-level-2"><a class=toc-link href=#minio><span class=toc-number>2.1.</span> <span class=toc-text>MinIO</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#prometheus><span class=toc-number>2.2.</span> <span class=toc-text>Prometheus</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#thanos><span class=toc-number>2.3.</span> <span class=toc-text>Thanos</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#sidecar><span class=toc-number>2.3.1.</span> <span class=toc-text>Sidecar</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#store><span class=toc-number>2.3.2.</span> <span class=toc-text>Store</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#query><span class=toc-number>2.3.3.</span> <span class=toc-text>Query</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class=toc-link href=#%E5%90%8E%E8%AE%B0><span class=toc-number>3.</span> <span class=toc-text>后记</span></a></li></ol><p>Prometheus 是很常用的服务指标监控系统。通过 Prometheus，我们将线上服务暴露的指标收集存储到时序数据库中，通过 PromQL 来查询，并在 Grafana 中展示。但是，使用小型 VPS 部署的个人项目而言，要在运行业务的同时运行这样一整服务监控系统，无论是长期储存时序数据所占用的磁盘空间，还是执行 PromQL 查询所占用的 CPU 资源，都太为难一台小型 VPS 了。</p><p>而相对的，家里 Homelab 服务器上有成本低廉的存储空间和计算资源，只是难以保证在线率，对 Metrics 这种需要不间断记录数据的场景不太适合 —— 如何才能将二者相结合，在 VPS 上实时收集自身服务的指标数据，同步到 Homelab 上进行储存和查询呢？</p><span id=more></span><h1 id=%E4%BB%8B%E7%BB%8D tabindex=-1>介绍 <a class=headerlink href=#%E4%BB%8B%E7%BB%8D></a></h1><p>Thanos 是一套基于 Prometheus 的服务监控方案，它为 Prometheus 扩展了中心化查询与长期存储的能力。通过 Thanos，我们可以将一个或多个 Prometheus 收集到的指标数据同步到对象存储（如 S3 兼容的对象存储）中，并通过连接到对象储存进行全局的 PromQL 查询。Thanos 有多个微服务组件，这里我们用到 Thanos Sidecar、Thanos Store 和 Thanos Query：</p><ul><li><strong>Thanos Sidecar:</strong> 在运行 Prometheus 的主机上运行，连接对象存储，将 Prometheus 的时序数据库产生的每个块自动上传到对象存储中；</li><li><strong>Thanos Store:</strong> 连接对象存储，对对象存储中的数据进行查询；</li><li><strong>Thanos Query:</strong> 将多个 Thanos 组件作为数据源组合起来，对整体数据进行查询。</li></ul><p>每个 Thanos 组件都会同时暴露 PromQL HTTP 接口和 Thanos StoreAPI gRPC 接口，所以既可以将 Thanos 组件用 Thanos Query 进行级联，也可以将任意一个 Thanos 组件实例接入 Grafana。</p><h1 id=%E9%83%A8%E7%BD%B2 tabindex=-1>部署 <a class=headerlink href=#%E9%83%A8%E7%BD%B2></a></h1><p>为了降低成本，我们使用自家 Homelab 上部署的 MinIO 代替 S3 / OSS 服务作为对象存储，并同时在 Homelab 上部署 Thanos Store 和 Thanos Query 来进行查询，而将 Prometheus 和 Thanos Sidecar 部署在每个业务服务器上。为了安全，将各个服务器之间用 VPN 组成内网，将这些服务全部监听在 VPN 内网上。</p><h2 id=minio tabindex=-1>MinIO <a class=headerlink href=#minio></a></h2><p>部署 MinIO 的方式不再赘述，这里只给出最简单的 Docker 部署的命令。有条件的也可以考虑把 MinIO 部署在家用 NAS 上。</p><div class=flex-wrapper><pre><code class=language-bash-prompt><span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6A737D># 建立 MinIO 数据目录</span></span>
<span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>mkdir</span><span style=color:#005CC5> -p</span><span style=color:#032F62> ~/minio-data</span></span>
<span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6A737D># 假设整个监控服务的 VPN 网段是 10.0.0.0/24，部署 MinIO 的主机是 10.0.0.1</span></span>
<span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>docker</span><span style=color:#032F62> run</span><span style=color:#005CC5> -d</span><span style=color:#005CC5> \</span></span>
<span class=line><span style=color:#005CC5>    -p</span><span style=color:#032F62> 10.0.0.1:9000:9000</span><span style=color:#005CC5> \</span></span>
<span class=line><span style=color:#005CC5>    --restart=unless-stopped</span><span style=color:#005CC5> \</span></span>
<span class=line><span style=color:#005CC5>    --name</span><span style=color:#032F62> minio</span><span style=color:#005CC5> \</span></span>
<span class=line><span style=color:#005CC5>    -v</span><span style=color:#032F62> ~/minio-data:/data</span><span style=color:#005CC5> \</span></span>
<span class=line><span style=color:#005CC5>    -e</span><span style=color:#032F62> "MINIO_ROOT_USER=&#x3C;MinIO AK>"</span><span style=color:#005CC5> \</span></span>
<span class=line><span style=color:#005CC5>    -e</span><span style=color:#032F62> "MINIO_ROOT_PASSWORD=&#x3C;MinIO SK>"</span><span style=color:#005CC5> \</span></span>
<span class=line><span style=color:#032F62>    quay.io/minio/minio</span><span style=color:#032F62> server</span><span style=color:#032F62> /data</span><span style=color:#005CC5> --console-address</span><span style=color:#032F62> :9001</span></span>
</code></pre></div><h2 id=prometheus tabindex=-1>Prometheus <a class=headerlink href=#prometheus></a></h2><p>在业务服务器上安装 Prometheus，一般直接使用包管理器安装即可。安装后修改其启动参数（Ubuntu / Debian 通过 APT 安装后在 <code class=punctuation-r>/etc/default/prometheus</code>）：</p><div class=flex-wrapper><pre><code class=language-yaml><span class=line><span style=color:#6A737D># 在 ARGS="" 中加入以下参数：</span></span>
<span class=line></span>
<span class=line><span style=color:#6A737D># 因为只需要暴露给本机的 Thanos Sidecar，所以监听 127.0.0.1 即可。</span></span>
<span class=line><span style=color:#032F62>--web.listen-address=127.0.0.1:9090</span></span>
<span class=line><span style=color:#6A737D># 设置一个稍长一点的存储时间，保证在 Homelab 暂时离线时不会丢失数据。</span></span>
<span class=line><span style=color:#032F62>--storage.tsdb.retention.time=7d</span></span>
<span class=line><span style=color:#6A737D># 将块大小设置为 2h（Thanos Sidecar 会在每个块生成后将其上传）。</span></span>
<span class=line><span style=color:#032F62>--storage.tsdb.max-block-duration=2h</span></span>
<span class=line><span style=color:#032F62>--storage.tsdb.min-block-duration=2h</span></span>
<span class=line><span style=color:#6A737D># 启用一些 Thanos Sidecar 会用到的接口。</span></span>
<span class=line><span style=color:#032F62>--web.enable-admin-api</span></span>
<span class=line><span style=color:#032F62>--web.enable-lifecycle</span></span>
<span class=line></span>
<span class=line><span style=color:#6A737D># 如果安装了一些 Prometheus Exporter（如 prometheus-node-exporter），</span></span>
<span class=line><span style=color:#6A737D># 建议也将它们改为仅监听本机。</span></span>
<span class=line></span></code></pre></div><p>在 Prometheus 配置中加入 <code class=punctuation-r>external_labels</code>，对来自该主机的所有数据添加标签：</p><div class=flex-wrapper><pre><code class=language-yaml><span class=line><span style=color:#22863A>global</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>  external_labels</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#6A737D>    # 用标签标明这些数据来自于哪里，注意不要和业务标签冲突。</span></span>
<span class=line><span style=color:#22863A>    monitor</span><span style=color:#24292E>: </span><span style=color:#032F62>my-vps</span></span>
<span class=line></span></code></pre></div><h2 id=thanos tabindex=-1>Thanos <a class=headerlink href=#thanos></a></h2><p>Thanos 不在 Ubuntu 和 Debian 的官方仓库中，但在 <a target=_blank rel=noopener href=https://github.com/cloudposse/packages>Cloud Posse 仓库</a>中有所提供。安装 Cloud Posse 的 DEB 仓库（对于其他发行版可以参考链接中的 README 进行安装）：</p><div class=flex-wrapper><pre><code class=language-bash-prompt><span class=hl-sh-prompt data-prompt="# "></span><span class=line><span style=color:#6F42C1>curl</span><span style=color:#005CC5> -1sLf</span><span style=color:#032F62> 'https://dl.cloudsmith.io/public/cloudposse/packages/cfg/setup/bash.deb.sh'</span><span style=color:#D73A49> |</span><span style=color:#6F42C1> bash</span></span>
</code></pre></div><p>然后 <code>apt install thanos</code> 即可安装 Thanos。但 Cloud Posse 提供的 Thanos 只有程序本身，没有 systemd 服务配置，需要自行编写。创建 <code class=punctuation-r>/etc/systemd/system/thanos@.service</code>（修改自 <a target=_blank rel=noopener href=https://github.com/thanos-io/thanos/issues/6865#issuecomment-1869227718>thanos-io/thanos#6865</a>）：</p><div class=flex-wrapper><pre><code class=language-ini><span class=line><span style=color:#6F42C1>[Unit]</span></span>
<span class=line><span style=color:#D73A49>Description</span><span style=color:#24292E>=Thanos (%i)</span></span>
<span class=line><span style=color:#D73A49>After</span><span style=color:#24292E>=network.target</span></span>
<span class=line><span style=color:#D73A49>RequiresMountsFor</span><span style=color:#24292E>=/etc/thanos</span></span>
<span class=line><span style=color:#D73A49>AssertPathExists</span><span style=color:#24292E>=/etc/thanos/%i.conf</span></span>
<span class=line></span>
<span class=line><span style=color:#6F42C1>[Service]</span></span>
<span class=line><span style=color:#D73A49>Type</span><span style=color:#24292E>=exec</span></span>
<span class=line><span style=color:#6A737D># The following reads words from `/etc/thanos/%i.conf`, unescapes any `\`-</span></span>
<span class=line><span style=color:#6A737D># escape-sequences for `printf`’s `b`-conversion-specifier in each word and uses</span></span>
<span class=line><span style=color:#6A737D># the resulting words as arguments to Thanos.</span></span>
<span class=line><span style=color:#D73A49>ExecStart</span><span style=color:#24292E>=sh -c </span><span style=color:#032F62>'name="$$1"; set --; for word in $$(grep -E -v "^[[:space:]]*(#.*)?$$" "/etc/thanos/$${name}.conf"); do set -- "$$@" "$$(printf "%%b" "$${word}")"; done; exec /usr/bin/thanos "$$@"'</span><span style=color:#032F62> ''</span><span style=color:#24292E> %i</span></span>
<span class=line></span>
<span class=line><span style=color:#D73A49>User</span><span style=color:#24292E>=prometheus</span></span>
<span class=line><span style=color:#D73A49>Group</span><span style=color:#24292E>=prometheus</span></span>
<span class=line></span>
<span class=line><span style=color:#D73A49>SyslogIdentifier</span><span style=color:#24292E>=thanos@%i</span></span>
<span class=line><span style=color:#D73A49>Restart</span><span style=color:#24292E>=on-failure</span></span>
<span class=line><span style=color:#D73A49>RestartPreventExitStatus</span><span style=color:#24292E>=SIGINT SIGTERM</span></span>
<span class=line></span>
<span class=line><span style=color:#6F42C1>[Install]</span></span>
<span class=line><span style=color:#D73A49>WantedBy</span><span style=color:#24292E>=multi-user.target</span></span>
<span class=line></span></code></pre></div><p>注意，为了方便读取 Prometheus 的数据文件，这里直接使用了 <code>prometheus</code> 用户和组。如果没有安装 Prometheus 请注意修改。</p><h3 id=sidecar tabindex=-1>Sidecar <a class=headerlink href=#sidecar></a></h3><p>在运行 Prometheus 的主机上启动 Thanos Sidecar。创建 <code class=punctuation-r>/etc/thanos/sidecar.conf</code>：</p><div class=flex-wrapper><pre><code class=language-yaml><span class=line><span style=color:#032F62>sidecar</span></span>
<span class=line><span style=color:#6A737D># 限制只能查询最近 3h 的数据，以免 Thanos Query 将过多的查询任务</span></span>
<span class=line><span style=color:#6A737D># 分配给 Thanos Sidecar。考虑到 Thanos Sidecar 每 2h 同步一个块</span></span>
<span class=line><span style=color:#6A737D># 到 MinIO，3h 足以填充最近的时间窗口。</span></span>
<span class=line><span style=color:#032F62>--min-time=-3h</span></span>
<span class=line><span style=color:#6A737D># 在 VPN 内网上暴露 Thanos StoreAPI gRPC 服务。</span></span>
<span class=line><span style=color:#032F62>--grpc-address=10.0.0.2:10901</span></span>
<span class=line><span style=color:#032F62>--http-address=10.0.0.2:10902</span></span>
<span class=line><span style=color:#6A737D># 指定本机的 Prometheus 端口，Thanos Store 会将查询下游的查询请求</span></span>
<span class=line><span style=color:#6A737D># 对应转发到 Prometheus 上。</span></span>
<span class=line><span style=color:#032F62>--prometheus.url=http://127.0.0.1:9090</span></span>
<span class=line><span style=color:#6A737D># 指定 Prometheus 的时序数据库路径，以下为 Debian / Ubuntu APT 安装</span></span>
<span class=line><span style=color:#6A737D># 后的默认路径。</span></span>
<span class=line><span style=color:#032F62>--tsdb.path=/var/lib/prometheus/metrics2/</span></span>
<span class=line><span style=color:#6A737D># 指定要上传到的对象存储，在单独的文件中配置。</span></span>
<span class=line><span style=color:#032F62>--objstore.config-file=/etc/thanos/objstore.yaml</span></span>
<span class=line></span></code></pre></div><p>并创建对象存储配置 <code class=punctuation-r>/etc/thanos/objstore.yaml</code>：</p><div class=flex-wrapper><pre><code class=language-yaml><span class=line><span style=color:#22863A>type</span><span style=color:#24292E>: </span><span style=color:#032F62>S3</span></span>
<span class=line><span style=color:#22863A>config</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>  bucket</span><span style=color:#24292E>: </span><span style=color:#032F62>thanos</span></span>
<span class=line><span style=color:#6A737D>  # 通过 VPN 连接到 Homelab 上的 MinIO。</span></span>
<span class=line><span style=color:#22863A>  endpoint</span><span style=color:#24292E>: </span><span style=color:#032F62>10.0.0.1:9000</span></span>
<span class=line><span style=color:#6A737D>  # `insecure` 表示使用 HTTP 而非 HTTPS。</span></span>
<span class=line><span style=color:#22863A>  insecure</span><span style=color:#24292E>: </span><span style=color:#005CC5>true</span></span>
<span class=line><span style=color:#22863A>  access_key</span><span style=color:#24292E>: </span><span style=color:#032F62>&#x3C;MinIO AK></span></span>
<span class=line><span style=color:#22863A>  secret_key</span><span style=color:#24292E>: </span><span style=color:#032F62>&#x3C;MinIO SK></span></span>
<span class=line></span></code></pre></div><p>启动 Thanos Sidecar（<code class="punctuation-r punctuation-l">systemctl enable --now thanos@sidecar</code>）后，如果一切正常，Thanos Sidecar 应当会输出：</p><div class=flex-wrapper><pre><code class=language-plain><span class=line><span>ts=2024-02-14T19:06:34.414308781Z caller=sidecar.go:195 level=info msg="successfully loaded prometheus version"</span></span>
<span class=line><span>ts=2024-02-14T19:06:34.415053542Z caller=sidecar.go:217 level=info msg="successfully loaded prometheus external labels" external_labels="{monitor=\"my-vps\"}"</span></span>
<span class=line><span>ts=2024-02-14T19:06:36.412919439Z caller=shipper.go:263 level=warn msg="reading meta file failed, will override it" err="failed to read /var/lib/prometheus/metrics2/thanos.shipper.json: open /var/lib/prometheus/metrics2/thanos.shipper.json: no such file or directory"</span></span>
<span class=line><span>ts=2024-02-14T19:06:36.504494277Z caller=shipper.go:361 level=info msg="upload new block" id=01HPM5YGK7IUD9PFK3FYSUJIN2</span></span>
<span class=line><span>ts=2024-02-14T19:06:39.282504533Z caller=shipper.go:361 level=info msg="upload new block" id=01HPM9DF4JODUT9L2PA8NG4UT4</span></span>
<span class=line><span></span></span></code></pre></div><p>其中 <code>reading meta file failed, will override it</code> 表示第一次启动，没有读取到上传进度文件，将会自动创建。如果又看到上传错误相关的信息，请检查对象存储是否配置正确。</p><h3 id=store tabindex=-1>Store <a class=headerlink href=#store></a></h3><p>在 Homelab 上启动 Thanos Store。为了方便这里直接将 Thanos Store 与 Thanos Query 部署在一起。</p><p>创建 <code class=punctuation-r>/etc/thanos/store.conf</code>：</p><div class=flex-wrapper><pre><code class=language-yaml><span class=line><span style=color:#032F62>store</span></span>
<span class=line><span style=color:#6A737D># 仅在本机暴露 Thanos StoreAPI gRPC 服务，供 Thanos Query 访问。</span></span>
<span class=line><span style=color:#032F62>--grpc-address=localhost:10901</span></span>
<span class=line><span style=color:#032F62>--http-address=localhost:10902</span></span>
<span class=line><span style=color:#6A737D># 需要注意的是，Thanos Store 本身不参与时序数据的存储，它只会连接</span></span>
<span class=line><span style=color:#6A737D># 对象存储服务进行查询，而磁盘上仅存储少量元数据。</span></span>
<span class=line><span style=color:#6A737D># 需要手动创建该目录，注意权限。</span></span>
<span class=line><span style=color:#032F62>--data-dir=/var/lib/thanos</span></span>
<span class=line><span style=color:#6A737D># 指定要上传到的对象存储，在单独的文件中配置。</span></span>
<span class=line><span style=color:#032F62>--objstore.config-file=/etc/thanos/objstore.yaml</span></span>
<span class=line></span></code></pre></div><p>并且同样创建 <code>/etc/thanos/objstore.yaml</code> 配置文件，连接 Homelab 上的 MinIO。</p><p>启动 Thanos Sidecar（<code class="punctuation-r punctuation-l">systemctl enable --now thanos@store</code>）后，如果一切正常，Thanos Sidecar 应当会输出：</p><div class=flex-wrapper><pre><code class=language-plain><span class=line><span>ts=2024-02-14T18:16:46.892043238Z caller=fetcher.go:557 level=info component=block.BaseFetcher msg="successfully synchronized block metadata" duration=7.928513ms duration_ms=7 cached=2 returned=2 partial=0</span></span>
<span class=line><span>ts=2024-02-14T18:16:46.904327891Z caller=bucket.go:757 level=info msg="loaded new block" elapsed=12.215001ms id=01HPM5YGK7IUD9PFK3FYSUJIN2</span></span>
<span class=line><span>ts=2024-02-14T18:16:46.904555976Z caller=bucket.go:757 level=info msg="loaded new block" elapsed=12.367995ms id=01HPM9DF4JODUT9L2PA8NG4UT4</span></span>
<span class=line><span>ts=2024-02-14T18:16:46.904609028Z caller=store.go:451 level=info msg="bucket store ready" init_duration=20.501403ms</span></span>
<span class=line><span>ts=2024-02-14T18:16:46.904732128Z caller=intrumentation.go:56 level=info msg="changing probe status" status=ready</span></span>
<span class=line><span>ts=2024-02-14T18:16:46.904780023Z caller=grpc.go:131 level=info service=gRPC/server component=store msg="listening for serving gRPC" address=127.0.0.1:10901</span></span>
<span class=line><span></span></span></code></pre></div><h3 id=query tabindex=-1>Query <a class=headerlink href=#query></a></h3><p>在 Homelab 上启动 Thanos Query。创建 <code class=punctuation-r>/etc/thanos/query.conf</code>：</p><div class=flex-wrapper><pre><code class=language-yaml><span class=line><span style=color:#032F62>query</span></span>
<span class=line><span style=color:#6A737D># 仅在本机暴露 Thanos StoreAPI gRPC 服务，供 Grafana 访问。</span></span>
<span class=line><span style=color:#6A737D># 如果需要在其他主机访问，建议使用 Nginx 进行 HTTPS 反代。</span></span>
<span class=line><span style=color:#032F62>--http-address=localhost:19090</span></span>
<span class=line><span style=color:#032F62>--grpc-address=localhost:10911</span></span>
<span class=line><span style=color:#6A737D># 如果需要在其他主机访问，启用 HTTP Basic Auth。</span></span>
<span class=line><span style=color:#032F62>--http.config=/etc/thanos/query-http.yaml</span></span>
<span class=line></span>
<span class=line><span style=color:#6A737D># 指定数据源，每个 `--store` 参数是一个数据源，与各个服务的</span></span>
<span class=line><span style=color:#6A737D># `--grpc-address` 相对应。</span></span>
<span class=line></span>
<span class=line><span style=color:#6A737D># Thanos Store 包含除最新一个块（2h）之外的所有历史数据。</span></span>
<span class=line><span style=color:#032F62>--store=localhost:10901</span></span>
<span class=line></span>
<span class=line><span style=color:#6A737D># 加入各个 VPS 上的 Thanos Sidecar，以查询最新数据。</span></span>
<span class=line><span style=color:#6A737D># 因为有 `--min-time` 的限制，所以 Thanos Sidecar 和对应</span></span>
<span class=line><span style=color:#6A737D># 的 Prometheus 不会有过大的压力。</span></span>
<span class=line></span>
<span class=line><span style=color:#6A737D># my-vps</span></span>
<span class=line><span style=color:#032F62>--store=10.0.0.2:10901</span></span>
<span class=line></span>
<span class=line><span style=color:#6A737D># my-vps-2</span></span>
<span class=line><span style=color:#032F62>--store=10.0.0.3:10901</span></span>
<span class=line></span>
<span class=line><span style=color:#6A737D># my-vps-3</span></span>
<span class=line><span style=color:#032F62>--store=10.0.0.4:10901</span></span>
<span class=line></span></code></pre></div><p>如果需要启用 HTTP Basic Auth，创建 <code class=punctuation-r>/etc/thanos/query-http.yaml</code>（密码使用 <a target=_blank rel=noopener href=https://en.wikipedia.org/wiki/Bcrypt>bcrypt</a> 哈希后存储）：</p><div class=flex-wrapper><pre><code class=language-yaml><span class=line><span style=color:#22863A>basic_auth_users</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>  my-grafana</span><span style=color:#24292E>: </span><span style=color:#032F62>$2y$04$wSTX2UC9pGdLB.1Dl7t1eOxXuIcerYgH/qJRf2id.m60hnuKbxKHm</span></span>
<span class=line></span></code></pre></div><p>最后在 Grafana 或者其他 PromQL 客户端上连接到 Thanos Query 的 HTTP 端口即可。Thanos Query 会自动根据各个 <code>--store</code> 数据源的元数据来得知他们提供的数据范围，来决定去哪些数据源查询。</p><h1 id=%E5%90%8E%E8%AE%B0 tabindex=-1>后记 <a class=headerlink href=#%E5%90%8E%E8%AE%B0></a></h1><p>除了使用 Thanos Sidecar 将 Prometheus 接入到 Thanos 中之外，还可以使用 Thanos Receiver 进行接入。Thanos Receiver 通过配置 Prometheus 的远程写入功能，来让 Prometheus 主动将数据推送给它，来取代主动读取 Prometheus 的时序数据库目录，这主要适用于当 Prometheus 运行在云上的托管环境，无法访问其数据目录的情况。除此之外，一般来说更推荐使用 Thanos Sidecar 进行接入。</p><p>此外，Thanos 还有一些其他组件：</p><ul><li><strong>Thanos Compactor:</strong> 对上传到对象存储中的数据进行压缩和降采样，减少空间占用；</li><li><strong>Thanos Query Frontend:</strong> 置于 Thanos Query 之前，对查询进行拆分和缓存，并能够对慢查询进行记录；</li><li><strong>Thanos Ruler:</strong> 通过预定义监控规则，自动监视 Thanos 数据源中的指标数据，当条件满足时触发告警。</li></ul></div></div><nav class=post-pagination><a class=newer-posts href=../how-does-kubectl-apply-merge/ >上一篇<br>Kubernetes 是如何合并 YAML 配置的？ </a><span class=page-number></span> <a class=older-posts href=../ipv6-slaac-relay-and-bridge/ >下一篇<br>SLAAC 环境下的 IPv6 桥接与中继</a></nav><div class=post-comment-wrapper-giscus><div class=giscus></div></div></div></div><div class=single-column-footer>Powered by <a href=https://hexo.io/ target=_blank rel="noreferrer noopener">Hexo</a><br>Theme <a href=https://github.com/Menci/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal</a> by <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a><br>&copy; 2024 <a href=https://blog.men.ci>Menci<i class=material-icons>favorite</i></a></div></div></div><script src=//cdnjs.baoshuo.ren/ajax/libs/jquery/3.3.1/jquery.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/popper.js/1.14.4/umd/popper.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/vue/2.5.17/vue.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/smooth-scroll/14.2.1/smooth-scroll.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js crossorigin=anonymous></script><script src=//static.cdn.menci.xyz/menci-blog/js/journal.bde01167.min.js crossorigin=anonymous></script><script src=//giscus.api.menci.xyz/client.js data-repo=Menci/blog data-repo-id=R_kgDOGsK5nA data-category=Comments data-category-id=DIC_kwDOGsK5nM4CAulO data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-theme=menci-blog data-lang=zh-CN async></script><script>"serviceWorker"in navigator&&window.addEventListener("load",(function(){navigator.serviceWorker.register("/sw.js?t=https%3A%2F%2Fstatic.cdn.menci.xyz%2Fmenci-blog%2F")}));</script></body></html>