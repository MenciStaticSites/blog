<!doctype html><html lang=zh-CN><head><title>Kubernetes 是如何合并 YAML 配置的？ - Menci&#39;s Blog</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=author content=Menci><meta name=description content="今天在更新一个以 StatefulSet 形式部署的服务时出现了一个诡异的问题：一个从 YAML 文件中被删掉的 ..."><meta name=keywords content=""><link rel=alternate type=application/atom+xml title="ATOM 1.0" href=/atom.xml><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=renderer content=webkit><meta name=theme-color content=#ffffff><link rel="shortcut icon" type=image/x-icon href=//static.cdn.menci.xyz/menci-blog/avatar.6e993e78.png crossorigin=anonymous><link rel=stylesheet href=//cdnjs.baoshuo.ren/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css crossorigin=anonymous><link rel=stylesheet href=//cdnjs.baoshuo.ren/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css crossorigin=anonymous><link rel=stylesheet href=//cdnjs.baoshuo.ren/ajax/libs/KaTeX/0.15.2/katex.min.css crossorigin=anonymous><link rel=stylesheet href=//static.cdn.menci.xyz/menci-blog/css/journal.b205a034.css crossorigin=anonymous><link rel=stylesheet href="//cdn.menci.xyz/fonts/css2?family=Noto+Sans+SC:wght@300%3B400%3B600&family=Source+Sans+Pro:wght@400%3B600&family=Lato:wght@400%3B500&family=Hind+Vadodara:wght@300%3B400&family=Montserrat&family=Fira+Code&family=Material+Icons&display=block" crossorigin=anonymous><script async data-domain=blog.men.ci src=//stat.u.sb/js/plausible.js></script><meta name=generator content="Hexo 7.3.0"></head><body><div id=top></div><div id=app><div class=single-column-drawer-container ref=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block false drawer-menu-item" href=https://blog.men.ci>首页 </a><a class="a-block false drawer-menu-item" href=/archives/ >归档 </a><a class="a-block false drawer-menu-item" href=/tags/ >标签 </a><a class="a-block false drawer-menu-item" href=/friends/ >朋友们 </a><a class="a-block false drawer-menu-item" href=/about-me/ >关于我</a></div></div></div><transition name=fade><div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav ref=navBar class="navbar navbar-light single-column-nav-container sticky-top"><div ref=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer><i class=material-icons>menu</i></button> <a ref=navTitle class=navbar-brand href=/ >Menci&#39;s Blog</a></div></nav><div class=single-column-header-container ref=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=/ ><div class=single-column-header-title>Menci's Blog</div><div class=single-column-header-subtitle>念念不忘，必有回响</div></a></div><div ref=sideContainer class=side-container><a class="a-block false nav-head" href=/ ><div class=nav-title>Menci's Blog</div><div class=nav-subtitle>念念不忘，必有回响</div></a><div class=nav-link-list><a class="a-block false nav-link-item" href=/archives/ >归档 </a><a class="a-block false nav-link-item" href=/tags/ >标签 </a><a class="a-block false nav-link-item" href=/friends/ >朋友们 </a><a class="a-block false nav-link-item" href=/about-me/ >关于我</a></div><div class=nav-footer>Powered by <a href=https://hexo.io/ target=_blank rel="noreferrer noopener">Hexo</a><br>Theme <a href=https://github.com/Menci/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal</a> by <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a><br>&copy; 2024 <a href=https://blog.men.ci>Menci<i class=material-icons>favorite</i></a></div></div><div ref=extraContainer class=extra-container><div class=pagination><a id=globalBackToTop class="animated-visibility pagination-action" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a></div></div><div ref=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only style="background-image: url('')"><div class=post-title>Kubernetes 是如何合并 YAML 配置的？<div class=post-meta><time datetime=2024-10-21T16:00:00.000Z itemprop=datePublished>2024-10-22 </time>&nbsp; <i class=material-icons style="">label</i> <a href=/tags/SRE/ >SRE</a>, <a href=/tags/云计算/ >云计算</a>, <a href=/tags/Kubernetes/ >Kubernetes</a></div></div></div><div class=post-body-wrapper><div class=post-body><ol class=toc><li class="toc-item toc-level-1"><a class=toc-link href=#%E5%A4%8D%E7%9B%98><span class=toc-number>1.</span> <span class=toc-text>复盘</span></a></li><li class="toc-item toc-level-1"><a class=toc-link href=#%E5%8E%9F%E5%9B%A0><span class=toc-number>2.</span> <span class=toc-text>原因</span></a></li><li class="toc-item toc-level-1"><a class=toc-link href=#%E8%A7%A3%E5%86%B3><span class=toc-number>3.</span> <span class=toc-text>解决</span></a></li><li class="toc-item toc-level-1"><a class=toc-link href=#%E5%8F%82%E8%80%83><span class=toc-number>4.</span> <span class=toc-text>参考</span></a></li></ol><p>今天在更新一个以 StatefulSet 形式部署的服务时出现了一个诡异的问题：一个从 YAML 文件中被删掉的 <code>env</code> 环境变量，在应用 YAML 后的 StatefulSet 对象中仍然存在，导致 Pod 中的应用程序没有正常运行。</p><p>而出现问题的 StatefulSet 资源，唯一的不寻常之处是 —— 上次更新（<code class="punctuation-l punctuation-r">apply -f</code>）后进行了回滚（<code class="punctuation-l punctuation-r">rollout undo</code>）……</p><span id=more></span><h1 id=%E5%A4%8D%E7%9B%98 tabindex=-1>复盘 <a class=headerlink href=#%E5%A4%8D%E7%9B%98></a></h1><p>首先，我们有一个 StatefulSet，它运行得很正常：</p><div class=flex-wrapper><pre><code class=language-yaml><span class=line><span style=color:#22863A>apiVersion</span><span style=color:#24292E>: </span><span style=color:#032F62>apps/v1</span></span>
<span class=line><span style=color:#22863A>kind</span><span style=color:#24292E>: </span><span style=color:#032F62>StatefulSet</span></span>
<span class=line><span style=color:#22863A>metadata</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>  name</span><span style=color:#24292E>: </span><span style=color:#032F62>my-wonderhoy-app</span></span>
<span class=line><span style=color:#22863A>  labels</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>    app</span><span style=color:#24292E>: </span><span style=color:#032F62>my-wonderhoy-app</span></span>
<span class=line><span style=color:#22863A>spec</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>  serviceName</span><span style=color:#24292E>: </span><span style=color:#032F62>my-wonderhoy-app</span></span>
<span class=line><span style=color:#22863A>  replicas</span><span style=color:#24292E>: </span><span style=color:#005CC5>3</span></span>
<span class=line><span style=color:#22863A>  selector</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>    matchLabels</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>      app</span><span style=color:#24292E>: </span><span style=color:#032F62>my-wonderhoy-app</span></span>
<span class=line><span style=color:#22863A>  template</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>    metadata</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>      labels</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>        app</span><span style=color:#24292E>: </span><span style=color:#032F62>my-wonderhoy-app</span></span>
<span class=line><span style=color:#22863A>    spec</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>      containers</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#24292E>      - </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>nginx</span></span>
<span class=line><span style=color:#22863A>        image</span><span style=color:#24292E>: </span><span style=color:#032F62>nginx:latest</span></span>
<span class=line><span style=color:#22863A>        env</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#24292E>        - </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>TO_BE_DELETED</span></span>
<span class=line><span style=color:#22863A>          value</span><span style=color:#24292E>: </span><span style=color:#032F62>needs to be deleted!</span></span>
<span class=line><span style=color:#24292E>        - </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>ANOTHER_ENV</span></span>
<span class=line><span style=color:#22863A>          value</span><span style=color:#24292E>: </span><span style=color:#032F62>who cares?</span></span>
<span class=line></span></code></pre></div><p>我们想要部署一个新版，进行了一些代码改动，发了一个新的 Docker 映像，并且不再需要其中的某一个 <code class=punctuation-r>env</code>：</p><div class=flex-wrapper><pre><code class=language-yaml><span class=line><span style=color:#22863A>apiVersion</span><span style=color:#24292E>: </span><span style=color:#032F62>apps/v1</span></span>
<span class=line><span style=color:#22863A>kind</span><span style=color:#24292E>: </span><span style=color:#032F62>StatefulSet</span></span>
<span class=line><span style=color:#22863A>metadata</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>  name</span><span style=color:#24292E>: </span><span style=color:#032F62>my-wonderhoy-app</span></span>
<span class=line><span style=color:#22863A>  labels</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>    app</span><span style=color:#24292E>: </span><span style=color:#032F62>my-wonderhoy-app</span></span>
<span class=line><span style=color:#22863A>spec</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>  serviceName</span><span style=color:#24292E>: </span><span style=color:#032F62>my-wonderhoy-app</span></span>
<span class=line><span style=color:#22863A>  replicas</span><span style=color:#24292E>: </span><span style=color:#005CC5>3</span></span>
<span class=line><span style=color:#22863A>  selector</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>    matchLabels</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>      app</span><span style=color:#24292E>: </span><span style=color:#032F62>my-wonderhoy-app</span></span>
<span class=line><span style=color:#22863A>  template</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>    metadata</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>      labels</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>        app</span><span style=color:#24292E>: </span><span style=color:#032F62>my-wonderhoy-app</span></span>
<span class=line><span style=color:#22863A>    spec</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>      containers</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#24292E>      - </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>nginx</span></span>
<span class=line><span style=color:#6A737D>        # 总之这个 image 不工作</span></span>
<span class=line><span style=color:#22863A>        image</span><span style=color:#24292E>: </span><span style=color:#032F62>nginx:a-broken-version</span></span>
<span class=line><span style=color:#22863A>        env</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#6A737D>        # 这个被删掉了！</span></span>
<span class=line><span style=color:#6A737D>        # - name: TO_BE_DELETED</span></span>
<span class=line><span style=color:#6A737D>        #   value: needs to be deleted!</span></span>
<span class=line><span style=color:#24292E>        - </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>ANOTHER_ENV</span></span>
<span class=line><span style=color:#22863A>          value</span><span style=color:#24292E>: </span><span style=color:#032F62>who cares?</span></span>
<span class=line></span></code></pre></div><p>然后，我们发现这个新版的 Docker 映像不工作，于是回滚到上一个版本：</p><div class=flex-wrapper><pre><code class=language-bash-prompt><span class=hl-sh-prompt data-prompt="$ "></span><span class=line><span style=color:#6A737D># 列出历史版本，找到上一个工作的版本</span></span>
<span class=hl-sh-prompt data-prompt="$ "></span><span class=line><span style=color:#6F42C1>kubectl</span><span style=color:#032F62> rollout</span><span style=color:#032F62> history</span><span style=color:#032F62> statefulset.apps/my-wonderhoy-app</span></span>
REVISION  CHANGE-CAUSE
1         kubectl apply -f my-wonderhoy-app-v1.yaml
2         kubectl apply -f my-wonderhoy-app-v2.yaml
<span class=hl-sh-prompt data-prompt="$ "></span><span class=line><span style=color:#6A737D># 回滚到所需的版本</span></span>
<span class=hl-sh-prompt data-prompt="$ "></span><span class=line><span style=color:#6F42C1>kubectl</span><span style=color:#032F62> rollout</span><span style=color:#032F62> undo</span><span style=color:#032F62> statefulset.apps/my-wonderhoy-app</span><span style=color:#005CC5> --to-revision=1</span></span>
statefulset.apps/my-wonderhoy-app rolled back
</code></pre></div><p>回滚后，我们的服务回到了正常工作的状态，它使用上一个版本的 Docker 映像，并且存在着被上一个版本所需要的 <code>TO_BE_DELETED</code> 变量。</p><p>而当我们修复了 Docker 映像的问题，再次部署新版时，我们发现 <code>TO_BE_DELETED</code> 这个变量并没有被删除：</p><div class=flex-wrapper><pre><code class=language-bash-prompt><span class=hl-sh-prompt data-prompt="$ "></span><span class=line><span style=color:#6F42C1>kubectl</span><span style=color:#032F62> apply</span><span style=color:#005CC5> -f</span><span style=color:#032F62> my-wonderhoy-app-v3.yaml</span></span>
statefulset.apps/my-wonderhoy-app configured
<span class=hl-sh-prompt data-prompt="$ "></span><span class=line><span style=color:#6F42C1>kubectl</span><span style=color:#032F62> get</span><span style=color:#032F62> statefulset.apps/my-wonderhoy-app</span><span style=color:#005CC5> -o</span><span style=color:#032F62> jsonpath='{.spec.template.spec.containers[0].env}'</span></span>
[map[name:TO_BE_DELETED value:needs to be deleted!] map[name:ANOTHER_ENV value:who cares?]]
</code></pre></div><h1 id=%E5%8E%9F%E5%9B%A0 tabindex=-1>原因 <a class=headerlink href=#%E5%8E%9F%E5%9B%A0></a></h1><p>这个问题是由于 <code>kubectl apply</code> 的合并策略导致的。<code class=punctuation-l>kubectl apply</code> 并不是简单地用新的 YAML 文件来替换掉集群中现有资源的配置，而是会遵循一个策略来进行合并。对于 <code>env</code> 的成员，Kubernetes 认为它是一种 Key-Value 结构，会对每个 Key 计算合并后的 Value。为了进行 Kubernetes 所认为的「正确」的合并，它对每个资源维护了一个 <code>last-applied-configuration</code> 字段，记录了上次使用 <code>kubectl apply</code> 时为它应用的 YAML 配置，而在本次 <code>kubectl apply</code> 中，它的合并策略是，对于一个 Key：</p><ul><li>如果该 Key 存在于新的 YAML 配置中，那么直接使用新的 Value；</li><li>如果该 Key 不存在于新的 YAML 配置中：<ul><li>如果该 Key 存在于上次应用的 YAML 配置中，Kubernetes 会认为这个 Key 应当被删除；</li><li><strong>如果该 Key 不存在于上次应用的 YAML 配置中，Kubernetes 会认为这个 Key 是被通过 YAML 文件之外的方式被添加的，不应当被删除。</strong></li></ul></li></ul><p>这个策略在大多数情况下是没有问题的，我们（在非调试用途下）一般不会通过 YAML 文件之外的方式来修改资源，所以 <code>last-applied-configuration</code> 一般会运行中的配置一致，使得 Kubernetes 能够正确地判断出哪些 Key 需要被删除。但这次巧合的是：</p><ol><li>首先，我们应用了一次（有 Bug 的）新 YAML 文件，这时 <code>last-applied-configuration</code> 中已经没有要删除的 <code>TO_BE_DELETED</code> 这个 Key 了；</li><li>然后，我们发现 Bug 之后回滚到了上一个版本，但 <code>last-applied-configuration</code> 没有被回滚，它之中仍然没有 <code>TO_BE_DELETED</code> 这个 Key；<ul><li>此时，工作中的该资源 <code>statefulset.apps/my-wonderhoy-app</code> 的配置就与 <code>last-applied-configuration</code> 不一致了；</li></ul></li><li>最后，重新应用（修复了 Bug 的）新 YAML 文件后，Kubernetes 的合并策略会认为 <code>TO_BE_DELETED</code> 是被通过 YAML 文件之外的方式添加的，不应当被删除。</li></ol><h1 id=%E8%A7%A3%E5%86%B3 tabindex=-1>解决 <a class=headerlink href=#%E8%A7%A3%E5%86%B3></a></h1><p>搞明白整个问题的流程之后，它就不可怕了。要解决它，只需要手动删掉这个没有被自动删掉的 <code>env</code> 即可：</p><div class=flex-wrapper><pre><code class=language-bash-prompt><span class=hl-sh-prompt data-prompt="$ "></span><span class=line><span style=color:#6F42C1>kubectl</span><span style=color:#032F62> edit</span><span style=color:#032F62> statefulset.apps/my-wonderhoy-app</span><span style=color:#6A737D> # 编辑 YAML 文件，删除掉不需要的 env</span></span>
statefulset.apps/my-wonderhoy-app edited
</code></pre></div><p>这个问题在一直使用 <code>kubectl apply</code> 的环境中不会出现，所以我们会误认为 <code>kubectl apply</code> 是一个简单的替换操作，但在手动修改了资源之后，就必须要考虑这个合并策略的问题了。</p><h1 id=%E5%8F%82%E8%80%83 tabindex=-1>参考 <a class=headerlink href=#%E5%8F%82%E8%80%83></a></h1><ul><li><a target=_blank rel=noopener href=https://kubernetes.io/docs/tasks/manage-kubernetes-objects/declarative-config/#merging-changes-to-primitive-fields>https://kubernetes.io/docs/tasks/manage-kubernetes-objects/declarative-config/#merging-changes-to-primitive-fields</a></li></ul></div></div><nav class=post-pagination><a class=newer-posts href=../cmcc-encrypted-pppoe-password/ >上一篇<br>被加密的移动光猫 PPPoE 密码 </a><span class=page-number></span> <a class=older-posts href=../thanos-low-cost-metrics-on-homelab/ >下一篇<br>使用 Thanos 低成本构建存储于 Homelab 上的多服务 Prometheus 监控</a></nav><div class=post-comment-wrapper-giscus><div class=giscus></div></div></div></div><div class=single-column-footer>Powered by <a href=https://hexo.io/ target=_blank rel="noreferrer noopener">Hexo</a><br>Theme <a href=https://github.com/Menci/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal</a> by <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a><br>&copy; 2024 <a href=https://blog.men.ci>Menci<i class=material-icons>favorite</i></a></div></div></div><script src=//cdnjs.baoshuo.ren/ajax/libs/jquery/3.3.1/jquery.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/popper.js/1.14.4/umd/popper.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/vue/2.5.17/vue.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/smooth-scroll/14.2.1/smooth-scroll.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js crossorigin=anonymous></script><script src=//static.cdn.menci.xyz/menci-blog/js/journal.bde01167.min.js crossorigin=anonymous></script><script src=//giscus.api.menci.xyz/client.js data-repo=Menci/blog data-repo-id=R_kgDOGsK5nA data-category=Comments data-category-id=DIC_kwDOGsK5nM4CAulO data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-theme=menci-blog data-lang=zh-CN async></script><script>"serviceWorker"in navigator&&window.addEventListener("load",(function(){navigator.serviceWorker.register("/sw.js?t=https%3A%2F%2Fstatic.cdn.menci.xyz%2Fmenci-blog%2F")}));</script></body></html>