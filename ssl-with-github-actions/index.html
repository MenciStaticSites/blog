<!doctype html><html lang=zh-CN><head><title>使用 GitHub Actions 自动申请与部署 ACME SSL 证书 - Menci&#39;s Blog</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=author content=Menci><meta name=description content="对于将 Web 服务部署在多个服务器与云服务的人来说，如何方便地申请并管理 SSL 证书，是一个值得思考的问题。我..."><meta name=keywords content=""><link rel=alternate type=application/atom+xml title="ATOM 1.0" href=/atom.xml><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=renderer content=webkit><meta name=theme-color content=#ffffff><link rel="shortcut icon" type=image/x-icon href=//static.cdn.menci.xyz/menci-blog/avatar.6e993e78.png crossorigin=anonymous><link rel=stylesheet href=//cdnjs.baoshuo.ren/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css crossorigin=anonymous><link rel=stylesheet href=//cdnjs.baoshuo.ren/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css crossorigin=anonymous><link rel=stylesheet href=//cdnjs.baoshuo.ren/ajax/libs/KaTeX/0.15.2/katex.min.css crossorigin=anonymous><link rel=stylesheet href=//static.cdn.menci.xyz/menci-blog/css/journal.b205a034.css crossorigin=anonymous><link rel=stylesheet href="//cdn.menci.xyz/fonts/css2?family=Noto+Sans+SC:wght@300%3B400%3B600&family=Source+Sans+Pro:wght@400%3B600&family=Lato:wght@400%3B500&family=Hind+Vadodara:wght@300%3B400&family=Montserrat&family=Fira+Code&family=Material+Icons&display=block" crossorigin=anonymous><script async data-domain=blog.men.ci src=//stat.u.sb/js/plausible.js></script><meta name=generator content="Hexo 7.3.0"></head><body><div id=top></div><div id=app><div class=single-column-drawer-container ref=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block false drawer-menu-item" href=https://blog.men.ci>首页 </a><a class="a-block false drawer-menu-item" href=/archives/ >归档 </a><a class="a-block false drawer-menu-item" href=/tags/ >标签 </a><a class="a-block false drawer-menu-item" href=/friends/ >朋友们 </a><a class="a-block false drawer-menu-item" href=/about-me/ >关于我</a></div></div></div><transition name=fade><div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav ref=navBar class="navbar navbar-light single-column-nav-container sticky-top"><div ref=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer><i class=material-icons>menu</i></button> <a ref=navTitle class=navbar-brand href=/ >Menci&#39;s Blog</a></div></nav><div class=single-column-header-container ref=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=/ ><div class=single-column-header-title>Menci's Blog</div><div class=single-column-header-subtitle>念念不忘，必有回响</div></a></div><div ref=sideContainer class=side-container><a class="a-block false nav-head" href=/ ><div class=nav-title>Menci's Blog</div><div class=nav-subtitle>念念不忘，必有回响</div></a><div class=nav-link-list><a class="a-block false nav-link-item" href=/archives/ >归档 </a><a class="a-block false nav-link-item" href=/tags/ >标签 </a><a class="a-block false nav-link-item" href=/friends/ >朋友们 </a><a class="a-block false nav-link-item" href=/about-me/ >关于我</a></div><div class=nav-footer>Powered by <a href=https://hexo.io/ target=_blank rel="noreferrer noopener">Hexo</a><br>Theme <a href=https://github.com/Menci/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal</a> by <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a><br>&copy; 2024 <a href=https://blog.men.ci>Menci<i class=material-icons>favorite</i></a></div></div><div ref=extraContainer class=extra-container><div class=pagination><a id=globalBackToTop class="animated-visibility pagination-action" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a></div></div><div ref=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper style="background-image: url('//static.cdn.menci.xyz/menci-blog/ssl-with-github-actions/banner.1461080a.svg')"><div class=post-title>使用 GitHub Actions 自动申请与部署 ACME SSL 证书<div class=post-meta><time datetime=2022-05-11T02:37:00.000Z itemprop=datePublished>2022-05-11 </time>&nbsp; <i class=material-icons style="">label</i> <a href=/tags/SRE/ >SRE</a>, <a href=/tags/云计算/ >云计算</a>, <a href=/tags/CI-CD/ >CI / CD</a>, <a href=/tags/SSL/ >SSL</a></div></div></div><div class=post-body-wrapper><div class=post-body><ol class=toc><li class="toc-item toc-level-1"><a class=toc-link href=#%E7%94%B3%E8%AF%B7%E8%AF%81%E4%B9%A6><span class=toc-number>1.</span> <span class=toc-text>申请证书</span></a><ol class=toc-child><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%87%86%E5%A4%87><span class=toc-number>1.1.</span> <span class=toc-text>准备</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#acme-action><span class=toc-number>1.2.</span> <span class=toc-text>ACME Action</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E4%B8%8A%E4%BC%A0%E8%AF%81%E4%B9%A6><span class=toc-number>1.3.</span> <span class=toc-text>上传证书</span></a></li></ol></li><li class="toc-item toc-level-1"><a class=toc-link href=#%E9%83%A8%E7%BD%B2%E8%AF%81%E4%B9%A6><span class=toc-number>2.</span> <span class=toc-text>部署证书</span></a><ol class=toc-child><li class="toc-item toc-level-2"><a class=toc-link href=#azure-key-vault><span class=toc-number>2.1.</span> <span class=toc-text>Azure Key Vault</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#azure-app-service><span class=toc-number>2.2.</span> <span class=toc-text>Azure App Service</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E9%98%BF%E9%87%8C%E4%BA%91><span class=toc-number>2.3.</span> <span class=toc-text>阿里云</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%8F%88%E6%8B%8D%E4%BA%91><span class=toc-number>2.4.</span> <span class=toc-text>又拍云</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E8%85%BE%E8%AE%AF%E4%BA%91><span class=toc-number>2.5.</span> <span class=toc-text>腾讯云</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%9C%8D%E5%8A%A1%E5%99%A8><span class=toc-number>2.6.</span> <span class=toc-text>服务器</span></a></li></ol></li><li class="toc-item toc-level-1"><a class=toc-link href=#%E5%AE%8C%E6%95%B4%E4%BE%8B%E5%AD%90><span class=toc-number>3.</span> <span class=toc-text>完整例子</span></a></li><li class="toc-item toc-level-1"><a class=toc-link href=#%E5%85%B3%E4%BA%8E-gts-%E8%AF%81%E4%B9%A6><span class=toc-number>4.</span> <span class=toc-text>关于 GTS 证书</span></a></li></ol><p>对于将 Web 服务部署在多个服务器与云服务的人来说，如何方便地申请并管理 SSL 证书，是一个值得思考的问题。我使用 GitHub Actions 来自动申请/续期 ACME SSL 证书，部署到各个云平台上，并在自己管理的服务器上定期拉取证书。</p><span id=more></span><p>首先创建一个私有 GitHub 仓库用于存放证书配置和各类凭据，以及存放申请到的证书。</p><h1 id=%E7%94%B3%E8%AF%B7%E8%AF%81%E4%B9%A6 tabindex=-1>申请证书 <a class=headerlink href=#%E7%94%B3%E8%AF%B7%E8%AF%81%E4%B9%A6></a></h1><h2 id=%E5%87%86%E5%A4%87 tabindex=-1>准备 <a class=headerlink href=#%E5%87%86%E5%A4%87></a></h2><p>首先请在本地（或自己的服务器上）成功使用 <a target=_blank rel=noopener href=https://acme.sh>acme.sh</a> 的 DNS-01 验证方式成功申请一次证书。这个过程包括：</p><ol><li>向 CA 注册 ACME 账户（如果使用 Let's Encrypt 则会自动进行，如果使用 ZeroSSL 或者 GTS 则需要手动注册）。</li><li>通过环境变量指定 DNS 提供商的凭据，用于添加/删除 ACME DNS-01 认证所需的 TXT 记录。</li><li>确认证书申请可以成功，为后续调试排除可能的问题。</li></ol><p>第一次申请证书后，CA 的 ACME 账户凭据将被存储到 <code>~/.acme.sh/ca</code> 中，DNS 提供商的凭据将被存储到 <code>~/.acme.sh/account.conf</code> 中。将它们打包并 BASE64 以备在 GitHub Actions 上使用：</p><div class=flex-wrapper><pre><code class=language-bash-prompt><span class=hl-sh-prompt data-prompt="$ "></span><span class=line><span style=color:#005CC5>cd</span><span style=color:#032F62> ~/.acme.sh</span></span>
<span class=hl-sh-prompt data-prompt="$ "></span><span class=line><span style=color:#6F42C1>tar</span><span style=color:#032F62> cz</span><span style=color:#032F62> ca</span><span style=color:#032F62> account.conf</span><span style=color:#D73A49> |</span><span style=color:#6F42C1> base64</span><span style=color:#005CC5> -w0</span></span>
</code></pre></div><p>将输出内容添加到 GitHub 仓库的 Secrets 中。</p><h2 id=acme-action tabindex=-1>ACME Action <a class=headerlink href=#acme-action></a></h2><p>使用 Action <a target=_blank rel=noopener href=https://github.com/marketplace/actions/issue-ssl-certificate><code>Menci/acme</code></a> 可以通过 acme.sh 申请 SSL 证书（使用 DNS-01 验证）。需要以下参数：</p><ul><li><code class=punctuation-r>account-tar</code>：用于指定 ACME 客户端的凭据。使用刚刚生成好的 Secret 即可。</li><li><code class=punctuation-r>domains-file</code>：指定一个文件，其中包含需要为其申请证书的域名列表，用空白字符隔开。<ul><li>亦可直接使用 <code>domain</code> 参数来指定域名列表，但不推荐直接将域名列表硬编码在 Workflow 文件中。</li><li>默认将包含它们对应的 wildcard 域名（即 <code>example.com</code> 会包含 <code class=punctuation-r>*.example.com</code>），如果不希望自动添加，则可以设置 <code>append-wildcard</code> 为 <code class=punctuation-r>false</code>。</li></ul></li><li><code class=punctuation-r>arguments-file</code>：指定一个文件，其中包含向 acme.sh 传递的参数列表。主要用于指定 <code>--dns</code> 和 <code>--server</code> 参数。如 <code class=punctuation-r>--dns dns_cf --server letsencrypt</code>。<ul><li>亦可直接使用 <code>arguments</code> 参数来指定参数列表。</li><li>其它常用参数如 <code>--valid-to</code> 和 <code>--challenge-alias</code> 也可以在此设定。</li></ul></li><li><code class=punctuation-r>output-fullchain</code>：输出 PEM 格式的全链证书文件的路径（如果目录不存在将自动创建，下同）。</li><li><code class=punctuation-r>output-key</code>：输出 PEM 格式的证书私钥文件的路径。</li><li><code class=punctuation-r>output-pfx</code>：输出 PFX 格式的全链证书文件的路径（如果不需要可以留空，上同）。<ul><li>使用 <code>output-pfx-password</code> 指定 PFX 文件的密码，随意指定即可。</li></ul></li></ul><p>另外，建议通过 <code>version</code> 参数指定 acme.sh 的版本（版本号或者 commit）来保持稳定性。</p><h2 id=%E4%B8%8A%E4%BC%A0%E8%AF%81%E4%B9%A6 tabindex=-1>上传证书 <a class=headerlink href=#%E4%B8%8A%E4%BC%A0%E8%AF%81%E4%B9%A6></a></h2><p>因为我们将在不同的 Job 中执行接下来的证书部署操作，我们需要在申请证书的 Job 的最后将证书 push 到仓库中（或者上传到 Artifacts 中）。</p><p>首先创建一个空的分支：</p><div class=flex-wrapper><pre><code class=language-bash-prompt><span class=hl-sh-prompt data-prompt="$ "></span><span class=line><span style=color:#6F42C1>mkdir</span><span style=color:#032F62> /tmp/empty-repo</span><span style=color:#24292E> &#x26;&#x26; </span><span style=color:#005CC5>cd</span><span style=color:#032F62> /tmp/empty-repo</span><span style=color:#24292E> &#x26;&#x26; </span><span style=color:#6F42C1>git</span><span style=color:#032F62> init</span><span style=color:#6A737D>   # 创建一个临时 repo</span></span>
<span class=hl-sh-prompt data-prompt="$ "></span><span class=line><span style=color:#6F42C1>git</span><span style=color:#032F62> commit</span><span style=color:#005CC5> --allow-empty</span><span style=color:#005CC5> -m</span><span style=color:#032F62> "Initial commit"</span><span style=color:#6A737D>              # 创建一个空的 commit</span></span>
<span class=hl-sh-prompt data-prompt="$ "></span><span class=line><span style=color:#6F42C1>git</span><span style=color:#032F62> push</span><span style=color:#032F62> git@github.com:</span><span style=color:#D73A49>&#x3C;</span><span style=color:#032F62>usernam</span><span style=color:#24292E>e</span><span style=color:#D73A49>></span><span style=color:#032F62>/</span><span style=color:#D73A49>&#x3C;</span><span style=color:#032F62>rep</span><span style=color:#24292E>o</span><span style=color:#D73A49>></span><span style=color:#032F62> HEAD:certs-main</span><span style=color:#6A737D> # push 到新的分支上</span></span>
</code></pre></div><p>在申请证书之前 checkout 这个分支到一个子目录，将申请到的证书放到这个目录下，并 commit-push 即可：</p><div class=flex-wrapper><pre><code class=language-yaml><span class=line><span style=color:#24292E>- </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>Push to GitHub</span></span>
<span class=line><span style=color:#22863A>  run</span><span style=color:#24292E>: </span><span style=color:#D73A49>|</span></span>
<span class=line><span style=color:#032F62>    git config --global user.name $(git show -s --format='%an' HEAD)</span></span>
<span class=line><span style=color:#032F62>    git config --global user.email $(git show -s --format='%ae' HEAD)</span></span>
<span class=line><span style=color:#032F62>    cd "$CERTS_OUTPUT_DIRECTORY"</span></span>
<span class=line><span style=color:#032F62>    git add "$FILE_KEY" "$FILE_FULLCHAIN" "$FILE_PFX"</span></span>
<span class=line><span style=color:#032F62>    git commit -m "[Actions/${<span></span>{ github.workflow }}] Upload certificates on $(date '+%Y-%m-%d %H:%M:%S')"</span></span>
<span class=line><span style=color:#032F62>    git push</span></span>
<span class=line><span style=color:#22863A>  env</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>    TZ</span><span style=color:#24292E>: </span><span style=color:#032F62>Asia/Shanghai</span></span>
<span class=line></span></code></pre></div><h1 id=%E9%83%A8%E7%BD%B2%E8%AF%81%E4%B9%A6 tabindex=-1>部署证书 <a class=headerlink href=#%E9%83%A8%E7%BD%B2%E8%AF%81%E4%B9%A6></a></h1><p>在申请证书的 Job 执行完成后，我们执行一系列 Job 来将证书部署到各个云服务。</p><h2 id=azure-key-vault tabindex=-1>Azure Key Vault <a class=headerlink href=#azure-key-vault></a></h2><p><a target=_blank rel=noopener href=https://azure.microsoft.com/en-us/services/key-vault/ >Key Vault</a> 是 Azure 提供的密钥存储服务，可以用于存储 SSL 证书。并可以用于在 <a target=_blank rel=noopener href=https://azure.microsoft.com/en-us/services/frontdoor/ >Front Door</a> 中使用。</p><p>使用 Azure CLI（<code class="punctuation-r punctuation-l">azure/CLI</code>）将证书部署到 Key Vault：</p><div class=flex-wrapper><pre><code class=language-yaml><span class=line><span style=color:#24292E>- </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>Login to Azure</span></span>
<span class=line><span style=color:#22863A>  uses</span><span style=color:#24292E>: </span><span style=color:#032F62>azure/login@v1</span></span>
<span class=line><span style=color:#22863A>  with</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>    creds</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ secrets.AZURE_CREDENTIALS }}</span></span>
<span class=line><span style=color:#24292E>- </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>Upload certificate</span></span>
<span class=line><span style=color:#22863A>  uses</span><span style=color:#24292E>: </span><span style=color:#032F62>azure/CLI@v1</span></span>
<span class=line><span style=color:#22863A>  with</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>    inlineScript</span><span style=color:#24292E>: </span><span style=color:#D73A49>|</span></span>
<span class=line><span style=color:#032F62>      az keyvault certificate import --subscription "$AZURE_SUBSCRIPTION" \</span></span>
<span class=line><span style=color:#032F62>                                     --vault-name "$AZURE_KEY_VAULT_NAME" \</span></span>
<span class=line><span style=color:#032F62>                                     --file "$CERTS_OUTPUT_DIRECTORY/$FILE_PFX" \</span></span>
<span class=line><span style=color:#032F62>                                     --name "$AZURE_KEY_CERTIFICATE_NAME" \</span></span>
<span class=line><span style=color:#032F62>                                     --password "$PFX_PASSWORD"</span></span>
<span class=line><span style=color:#22863A>  env</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>    AZURE_SUBSCRIPTION</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ matrix.subscription }}</span></span>
<span class=line><span style=color:#22863A>    AZURE_KEY_VAULT_NAME</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ matrix.vault-name }}</span></span>
<span class=line><span style=color:#22863A>    AZURE_KEY_CERTIFICATE_NAME</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ matrix.certificate-name }}</span></span>
<span class=line></span></code></pre></div><p>在 Front Door 中指定来自 Key Vault 的证书后，证书将自动更新。</p><p>所使用的 Service Principal 需要拥有该 Key Vault 的 Certificate → Import 权限。使用以下命令可以创建一个 Service Principal：</p><div class=flex-wrapper><pre><code class=language-bash-prompt><span class=hl-sh-prompt data-prompt="$ "></span><span class=line><span style=color:#6F42C1>az</span><span style=color:#032F62> ad</span><span style=color:#032F62> sp</span><span style=color:#032F62> create-for-rbac</span><span style=color:#005CC5> --name</span><span style=color:#032F62> SSLCertificateUploader</span></span>
{
  &quot;appId&quot;: &quot;019d7f61-a969-4daa-b53f-f2341f6f4705&quot;,
  &quot;displayName&quot;: &quot;SSLCertificateUploader&quot;,
  &quot;password&quot;: &quot;vCGS5BQMm.BI~6BEjjCa-j6tZ2fCxJsENA&quot;,
  &quot;tenant&quot;: &quot;72f988bf-86f1-41af-91ab-2d7cd011db47&quot;
}
</code></pre></div><p>输出的内容即为该 Service Principal 的凭据（<a target=_blank rel=noopener href=https://github.com/Azure/login/blob/6bc1b5ecb97c62c523edc56f8da91d422a1c2efc/README.md#configure-deployment-credentials>建议删除换行</a>以免 <code>{</code> 和 <code>}</code> 被认为是 Secret，导致在 Actions 的输出中被遮盖）。在 Azure Portal 中为其<a target=_blank rel=noopener href="https://docs.microsoft.com/en-us/azure/key-vault/general/assign-access-policy?tabs=azure-portal">赋予权限</a>即可。</p><h2 id=azure-app-service tabindex=-1>Azure App Service <a class=headerlink href=#azure-app-service></a></h2><p><a target=_blank rel=noopener href=https://azure.microsoft.com/en-us/services/app-service/ >App Service</a>（<a target=_blank rel=noopener href=https://azure.microsoft.com/en-us/services/functions/ >Function App</a> 同理）是 Azure 提供的 Web 应用服务。App Service 绑定的域名需要手动上传 SSL 证书（也可从 Key Vault 中导入，但导入是一次性的，不会像 Front Door 一样自动更新）。</p><p>使用 <a target=_blank rel=noopener href=https://github.com/marketplace/actions/deploy-ssl-certificate-to-azure-web-app><code>Menci/deploy-certificate-to-azure-web-app</code></a> 将证书部署到 App Service：</p><div class=flex-wrapper><pre><code class=language-yaml><span class=line><span style=color:#24292E>- </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>Deploy certificate</span></span>
<span class=line><span style=color:#22863A>  uses</span><span style=color:#24292E>: </span><span style=color:#032F62>Menci/deploy-certificate-to-azure-web-app@beta-v2</span></span>
<span class=line><span style=color:#22863A>  with</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>    azcliversion</span><span style=color:#24292E>: </span><span style=color:#005CC5>2.28.0</span></span>
<span class=line><span style=color:#22863A>    creds</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ secrets.AZURE_CREDENTIALS }}</span></span>
<span class=line><span style=color:#22863A>    subscription</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ matrix.subscription }}</span></span>
<span class=line><span style=color:#22863A>    resource-group</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ matrix.resource-group }}</span></span>
<span class=line><span style=color:#22863A>    webapp-name</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ matrix.webapp-name }}</span></span>
<span class=line><span style=color:#22863A>    certificate-file</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.CERTS_OUTPUT_DIRECTORY }}/${<span></span>{ env.FILE_PFX }}</span></span>
<span class=line><span style=color:#22863A>    certificate-password</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.PFX_PASSWORD }}</span></span>
<span class=line><span style=color:#22863A>    delete-old-certificates</span><span style=color:#24292E>: </span><span style=color:#005CC5>true</span></span>
<span class=line></span></code></pre></div><p>该 Action 会将新的证书上传到 App Service 所在的 Resource Group 中，并为该 App Service 所绑定的所有匹配的域名应用该证书。当 <code>delete-old-certificates</code> 参数为 <code>true</code> 时，将自动删除该 App Service 之前使用的所有证书（包含非本 Action 上传的证书）。</p><p>所使用的 Service Principal 需要拥有 Resource Group 级别（而非 Resource 级别，因为同一个 Resource Group 的 SSL 证书是共享的）的 Website Contributor	权限。在 Azure Portal 中为其<a target=_blank rel=noopener href="https://docs.microsoft.com/en-us/azure/role-based-access-control/role-assignments-portal?tabs=current">赋予权限</a>即可。</p><h2 id=%E9%98%BF%E9%87%8C%E4%BA%91 tabindex=-1>阿里云 <a class=headerlink href=#%E9%98%BF%E9%87%8C%E4%BA%91></a></h2><p>阿里云的 <a target=_blank rel=noopener href=https://www.aliyun.com/product/cas>SSL 证书服务</a>支持上传自定义证书，该证书可以用于阿里云 <a target=_blank rel=noopener href=https://www.aliyun.com/product/cdn>CDN</a>。阿里云暂未提供将证书部署至 <a target=_blank rel=noopener href=https://www.aliyun.com/product/oss>OSS</a> 的 API，建议 OSS 用户使用 CDN 回源 OSS 来代替。</p><p>使用 <a target=_blank rel=noopener href=https://github.com/marketplace/actions/deploy-ssl-certificate-to-aliyun><code>Menci/deploy-certificate-to-aliyun</code></a> 将证书部署到阿里云：</p><div class=flex-wrapper><pre><code class=language-yaml><span class=line><span style=color:#24292E>- </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>Deploy certificate</span></span>
<span class=line><span style=color:#22863A>  uses</span><span style=color:#24292E>: </span><span style=color:#032F62>Menci/deploy-certificate-to-aliyun@beta-v1</span></span>
<span class=line><span style=color:#22863A>  with</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>    access-key-id</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ secrets.ALIYUN_ACCESS_KEY_ID }}</span></span>
<span class=line><span style=color:#22863A>    access-key-secret</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ secrets.ALIYUN_ACCESS_KEY_SECRET }}</span></span>
<span class=line><span style=color:#22863A>    fullchain-file</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.CERTS_OUTPUT_DIRECTORY }}/${<span></span>{ env.FILE_FULLCHAIN }}</span></span>
<span class=line><span style=color:#22863A>    key-file</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.CERTS_OUTPUT_DIRECTORY }}/${<span></span>{ env.FILE_KEY }}</span></span>
<span class=line><span style=color:#22863A>    certificate-name</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ matrix.certificate-name }}</span></span>
<span class=line><span style=color:#22863A>    cdn-domains</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ join(matrix.cdn-domains, ' ') }}</span></span>
<span class=line></span></code></pre></div><p>其中 <code>certificate-name</code> 指定上传的证书在证书服务中的名称（将自动替换旧版本），<code class=punctuation-l>cdn-domain</code> 指定需要将该证书部署到的 CDN 域名列表（用空白字符隔开）。</p><p>建议使用子账户 Access Key，为其赋予以下权限（并按需使用资源组隔离）：</p><ul><li><code>AliyunYundunCertFullAccess</code></li><li><code>AliyunCDNFullAccess</code></li><li><code>AliyunPCDNFullAccess</code></li><li><code>AliyunSCDNFullAccess</code></li><li><code>AliyunDCDNFullAccess</code></li></ul><h2 id=%E5%8F%88%E6%8B%8D%E4%BA%91 tabindex=-1>又拍云 <a class=headerlink href=#%E5%8F%88%E6%8B%8D%E4%BA%91></a></h2><p>又拍云的<a target=_blank rel=noopener href=http://docs.upyun.com/cdn/ssl/ >证书服务</a>支持上传自定义证书，该证书可以用于又拍云所有服务。</p><p>使用 <a target=_blank rel=noopener href=https://github.com/marketplace/actions/deploy-ssl-certificate-to-upyun><code>Menci/deploy-certificate-to-upyun</code></a> 将证书部署到又拍云：</p><div class=flex-wrapper><pre><code class=language-yaml><span class=line><span style=color:#24292E>- </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>Deploy certificate</span></span>
<span class=line><span style=color:#22863A>  uses</span><span style=color:#24292E>: </span><span style=color:#032F62>Menci/deploy-certificate-to-upyun@beta-v2</span></span>
<span class=line><span style=color:#22863A>  with</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>    subaccount-username</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ secrets.UPYUN_SUBACCOUNT_USERNAME }}</span></span>
<span class=line><span style=color:#22863A>    subaccount-password</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ secrets.UPYUN_SUBACCOUNT_PASSWORD }}</span></span>
<span class=line><span style=color:#22863A>    fullchain-file</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.CERTS_OUTPUT_DIRECTORY }}/${<span></span>{ env.FILE_FULLCHAIN }}</span></span>
<span class=line><span style=color:#22863A>    key-file</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.CERTS_OUTPUT_DIRECTORY }}/${<span></span>{ env.FILE_KEY }}</span></span>
<span class=line><span style=color:#22863A>    domains</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ join(matrix.domains, ' ') }}</span></span>
<span class=line><span style=color:#22863A>    delete-unused-certificates</span><span style=color:#24292E>: </span><span style=color:#005CC5>true</span></span>
<span class=line></span></code></pre></div><p>其中 <code>domains</code> 指定需要将该证书部署到的域名列表（用空白字符隔开）。当 <code>delete-unused-certificates</code> 为 <code>true</code> 时，将自动删除所有未使用的旧证书（包含非本 Action 上传的证书，以及在又拍云申请的证书）。</p><p>由于又拍云没有提供证书相关的公开 API，该 Action 使用控制台 API 实现，所以需要提供子账户的用户名和密码，而非 Access Key 和 Secret Key。</p><h2 id=%E8%85%BE%E8%AE%AF%E4%BA%91 tabindex=-1>腾讯云 <a class=headerlink href=#%E8%85%BE%E8%AE%AF%E4%BA%91></a></h2><p>见<a target=_blank rel=noopener href=https://blog.baoshuo.ren/post/actions-ssl-cert/#%E8%85%BE%E8%AE%AF%E4%BA%91>宝硕博客</a>。</p><h2 id=%E6%9C%8D%E5%8A%A1%E5%99%A8 tabindex=-1>服务器 <a class=headerlink href=#%E6%9C%8D%E5%8A%A1%E5%99%A8></a></h2><p>通过 GitHub Actions 自动向服务器部署证书较为困难，特别是对于位于 NAT 后的服务器而言。我的解决方法是让服务器自动从 Azure Key Vault 中拉取证书。如果你不使用 Azure Key Vault，也可以考虑直接从 GitHub 仓库中拉取证书（使用只读的 Deploy Keys 可以达到权限最小化，但只能控制到仓库级别，无法控制到分支级别）。</p><p>下载证书所用的 Service Principal 需要拥有该 Key Vault 的 Secret → Get 权限（而非 Certificate → Get 权限，该权限仅可读取证书本身，不可读取证书私钥）。与上文同理，创建一个 Service Principal 并赋予权限（建议使用不同的 Service Principal 上传和下载证书），并在服务器上登录（其中 <code>username</code> 即为 <code class=punctuation-r>appId</code>）：</p><div class=flex-wrapper><pre><code class=language-bash-prompt><span class=hl-sh-prompt data-prompt="$ "></span><span class=line><span style=color:#6F42C1>az</span><span style=color:#032F62> login</span><span style=color:#005CC5> --service-principal</span><span style=color:#005CC5> \</span></span>
<span class=line><span style=color:#005CC5>           --username</span><span style=color:#032F62> 218acab1-8f2d-4f0c-ab30-8931332058d3</span><span style=color:#005CC5> \</span></span>
<span class=line><span style=color:#005CC5>           --password</span><span style=color:#032F62> 'fbrDxvS0~mWQ8QcHVLQzqAuJhOHDR9-YW4'</span><span style=color:#005CC5> \</span></span>
<span class=line><span style=color:#005CC5>           --tenant</span><span style=color:#032F62> 72f988bf-86f1-41af-91ab-2d7cd011db47</span></span>
</code></pre></div><p>登录 Azure CLI 后，使用以下脚本自动从 Azure Key Vault 中拉取证书（记得 <code class=punctuation-r>chmod +x</code>）：</p><div class=flex-wrapper><pre><code class=language-bash><span class=line><span style=color:#6A737D>#!/bin/bash -e</span></span>
<span class=line></span>
<span class=line><span style=color:#24292E>AZURE_CERT_URI</span><span style=color:#D73A49>=</span><span style=color:#032F62>"https://&#x3C;你的 Key Vault 名称>.vault.azure.net/secrets/&#x3C;你的 Key Vault 中证书的名称>"</span></span>
<span class=line><span style=color:#24292E>INSTALL_KEY</span><span style=color:#D73A49>=</span><span style=color:#032F62>"/etc/nginx/ssl/ssl.key"</span><span style=color:#6A737D>  # PEM 私钥的目标位置</span></span>
<span class=line><span style=color:#24292E>INSTALL_CERT</span><span style=color:#D73A49>=</span><span style=color:#032F62>"/etc/nginx/ssl/ssl.crt"</span><span style=color:#6A737D> # PEM 全链的目标位置</span></span>
<span class=line><span style=color:#24292E>INSTALL_CMD</span><span style=color:#D73A49>=</span><span style=color:#032F62>"systemctl reload nginx"</span><span style=color:#6A737D>  # 应用证书的命令</span></span>
<span class=line></span>
<span class=line><span style=color:#6F42C1>rm</span><span style=color:#005CC5> -rf</span><span style=color:#032F62> /tmp/update-cert</span></span>
<span class=line><span style=color:#6F42C1>mkdir</span><span style=color:#032F62> /tmp/update-cert</span></span>
<span class=line><span style=color:#005CC5>cd</span><span style=color:#032F62> /tmp/update-cert</span></span>
<span class=line></span>
<span class=line><span style=color:#6A737D># 下载 PFX 格式的证书</span></span>
<span class=line><span style=color:#6F42C1>az</span><span style=color:#032F62> keyvault</span><span style=color:#032F62> secret</span><span style=color:#032F62> download</span><span style=color:#005CC5> --id</span><span style=color:#032F62> "</span><span style=color:#24292E>$AZURE_CERT_URI</span><span style=color:#032F62>"</span><span style=color:#005CC5> --encoding</span><span style=color:#032F62> base64</span><span style=color:#005CC5> --file</span><span style=color:#032F62> cert.pfx</span></span>
<span class=line></span>
<span class=line><span style=color:#6A737D># 转换为 PEM 格式</span></span>
<span class=line><span style=color:#6F42C1>openssl</span><span style=color:#032F62> pkcs12</span><span style=color:#005CC5> -in</span><span style=color:#032F62> cert.pfx</span><span style=color:#005CC5> -nocerts</span><span style=color:#005CC5> -out</span><span style=color:#032F62> key-enc.pem</span><span style=color:#005CC5> -passin</span><span style=color:#032F62> pass:</span><span style=color:#005CC5> -passout</span><span style=color:#032F62> pass:pass</span></span>
<span class=line><span style=color:#6F42C1>openssl</span><span style=color:#032F62> pkcs12</span><span style=color:#005CC5> -in</span><span style=color:#032F62> cert.pfx</span><span style=color:#005CC5> -nokeys</span><span style=color:#005CC5> -out</span><span style=color:#032F62> cert.pem</span><span style=color:#005CC5> -passin</span><span style=color:#032F62> pass:</span></span>
<span class=line><span style=color:#6F42C1>openssl</span><span style=color:#032F62> rsa</span><span style=color:#005CC5> -in</span><span style=color:#032F62> key-enc.pem</span><span style=color:#005CC5> -out</span><span style=color:#032F62> key.pem</span><span style=color:#005CC5> -passin</span><span style=color:#032F62> pass:pass</span></span>
<span class=line></span>
<span class=line><span style=color:#6F42C1>cp</span><span style=color:#032F62> key.pem</span><span style=color:#032F62> "</span><span style=color:#24292E>$INSTALL_KEY</span><span style=color:#032F62>"</span></span>
<span class=line><span style=color:#6F42C1>cp</span><span style=color:#032F62> cert.pem</span><span style=color:#032F62> "</span><span style=color:#24292E>$INSTALL_CERT</span><span style=color:#032F62>"</span></span>
<span class=line></span>
<span class=line><span style=color:#24292E>$INSTALL_CMD</span></span>
<span class=line></span></code></pre></div><p>将该脚本添加到 <code>cron</code> 即可定期运行，如：</p><div class=flex-wrapper><pre><code class=language-crontab><span class=line><span style=color:#005CC5>0</span><span style=color:#005CC5> 20</span><span style=color:#005CC5> *</span><span style=color:#005CC5> *</span><span style=color:#005CC5> *</span><span style=color:#032F62> /root/update-cert.sh</span></span>
<span class=line></span></code></pre></div><h1 id=%E5%AE%8C%E6%95%B4%E4%BE%8B%E5%AD%90 tabindex=-1>完整例子 <a class=headerlink href=#%E5%AE%8C%E6%95%B4%E4%BE%8B%E5%AD%90></a></h1><p>这里给出一个完整的例子，即我目前使用的配置。在 <code>main/options</code> 和 <code>main/domains</code> 文件中指定参数和域名列表，在 <code>main/deploy.json</code> 中指定部署目标，每一类部署目标可以有多个（主要是 Azure App Service）。</p><p>GitHub Workflow 文件（将在每周三、周六的 UTC+0 零点自动更新证书）：</p><div class=flex-wrapper><pre><code class=language-yaml><span class=line><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>Main</span></span>
<span class=line><span style=color:#005CC5>on</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>  workflow_dispatch</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>  schedule</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#24292E>    - </span><span style=color:#22863A>cron</span><span style=color:#24292E>: </span><span style=color:#032F62>'0 0 * * SAT'</span></span>
<span class=line><span style=color:#24292E>    - </span><span style=color:#22863A>cron</span><span style=color:#24292E>: </span><span style=color:#032F62>'0 0 * * WED'</span></span>
<span class=line><span style=color:#22863A>env</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>  TARGET</span><span style=color:#24292E>: </span><span style=color:#032F62>main</span></span>
<span class=line><span style=color:#22863A>  CERTS_OUTPUT_DIRECTORY</span><span style=color:#24292E>: </span><span style=color:#032F62>certs-output</span></span>
<span class=line><span style=color:#22863A>  FILE_FULLCHAIN</span><span style=color:#24292E>: </span><span style=color:#032F62>fullchain.pem</span></span>
<span class=line><span style=color:#22863A>  FILE_KEY</span><span style=color:#24292E>: </span><span style=color:#032F62>key.pem</span></span>
<span class=line><span style=color:#22863A>  FILE_PFX</span><span style=color:#24292E>: </span><span style=color:#032F62>certificate.pfx</span></span>
<span class=line><span style=color:#22863A>  PFX_PASSWORD</span><span style=color:#24292E>: </span><span style=color:#032F62>qwq</span></span>
<span class=line><span style=color:#22863A>jobs</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>  issue-push</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>    name</span><span style=color:#24292E>: </span><span style=color:#032F62>Issue &#x26; Push</span></span>
<span class=line><span style=color:#22863A>    runs-on</span><span style=color:#24292E>: </span><span style=color:#032F62>ubuntu-latest</span></span>
<span class=line><span style=color:#22863A>    steps</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#24292E>    - </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>Checkout</span></span>
<span class=line><span style=color:#22863A>      uses</span><span style=color:#24292E>: </span><span style=color:#032F62>actions/checkout@v2</span></span>
<span class=line><span style=color:#22863A>      with</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>        ref</span><span style=color:#24292E>: </span><span style=color:#032F62>main</span></span>
<span class=line><span style=color:#24292E>    - </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>Checkout output branch</span></span>
<span class=line><span style=color:#22863A>      uses</span><span style=color:#24292E>: </span><span style=color:#032F62>actions/checkout@v2</span></span>
<span class=line><span style=color:#22863A>      with</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>        ref</span><span style=color:#24292E>: </span><span style=color:#032F62>certs-${<span></span>{ env.TARGET }}</span></span>
<span class=line><span style=color:#22863A>        path</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.CERTS_OUTPUT_DIRECTORY }}</span></span>
<span class=line><span style=color:#24292E>    - </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>Issue certificate</span></span>
<span class=line><span style=color:#22863A>      uses</span><span style=color:#24292E>: </span><span style=color:#032F62>Menci/acme@main</span></span>
<span class=line><span style=color:#22863A>      with</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>        version</span><span style=color:#24292E>: </span><span style=color:#032F62>83da01a2e1f5384ed997f9e023ea4a813dcac1f0</span></span>
<span class=line><span style=color:#22863A>        account-tar</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ secrets.ACME_SH_ACCOUNT_TAR }}</span></span>
<span class=line><span style=color:#22863A>        domains-file</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.CONFIG_DOMAINS }}</span></span>
<span class=line><span style=color:#22863A>        arguments-file</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.CONFIG_OPTIONS }}</span></span>
<span class=line><span style=color:#22863A>        output-fullchain</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.CERTS_OUTPUT_DIRECTORY }}/${<span></span>{ env.FILE_FULLCHAIN }}</span></span>
<span class=line><span style=color:#22863A>        output-key</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.CERTS_OUTPUT_DIRECTORY }}/${<span></span>{ env.FILE_KEY }}</span></span>
<span class=line><span style=color:#22863A>        output-pfx</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.CERTS_OUTPUT_DIRECTORY }}/${<span></span>{ env.FILE_PFX }}</span></span>
<span class=line><span style=color:#22863A>        output-pfx-password</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.PFX_PASSWORD }}</span></span>
<span class=line><span style=color:#22863A>      env</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>        CONFIG_DOMAINS</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.TARGET }}/domains</span></span>
<span class=line><span style=color:#22863A>        CONFIG_OPTIONS</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.TARGET }}/options</span></span>
<span class=line><span style=color:#24292E>    - </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>Push to GitHub</span></span>
<span class=line><span style=color:#22863A>      run</span><span style=color:#24292E>: </span><span style=color:#D73A49>|</span></span>
<span class=line><span style=color:#032F62>        git config --global user.name $(git show -s --format='%an' HEAD)</span></span>
<span class=line><span style=color:#032F62>        git config --global user.email $(git show -s --format='%ae' HEAD)</span></span>
<span class=line><span style=color:#032F62>        cd "$CERTS_OUTPUT_DIRECTORY"</span></span>
<span class=line><span style=color:#032F62>        git add "$FILE_KEY" "$FILE_FULLCHAIN" "$FILE_PFX"</span></span>
<span class=line><span style=color:#032F62>        git commit -m "[Actions/${<span></span>{ github.workflow }}] Upload certificates on $(date '+%Y-%m-%d %H:%M:%S')"</span></span>
<span class=line><span style=color:#032F62>        git push</span></span>
<span class=line><span style=color:#22863A>      env</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>        TZ</span><span style=color:#24292E>: </span><span style=color:#032F62>Asia/Shanghai</span></span>
<span class=line><span style=color:#22863A>  deployment-config</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>    name</span><span style=color:#24292E>: </span><span style=color:#032F62>Load Deployment Config</span></span>
<span class=line><span style=color:#22863A>    runs-on</span><span style=color:#24292E>: </span><span style=color:#032F62>ubuntu-latest</span></span>
<span class=line><span style=color:#22863A>    outputs</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>      config</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ steps.read-deployment-config.outputs.config }}</span></span>
<span class=line><span style=color:#22863A>    steps</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#24292E>    - </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>Checkout</span></span>
<span class=line><span style=color:#22863A>      uses</span><span style=color:#24292E>: </span><span style=color:#032F62>actions/checkout@v2</span></span>
<span class=line><span style=color:#22863A>      with</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>        ref</span><span style=color:#24292E>: </span><span style=color:#032F62>main</span></span>
<span class=line><span style=color:#24292E>    - </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>Read Deployment Config</span></span>
<span class=line><span style=color:#22863A>      id</span><span style=color:#24292E>: </span><span style=color:#032F62>read-deployment-config</span></span>
<span class=line><span style=color:#22863A>      run</span><span style=color:#24292E>: </span><span style=color:#D73A49>|</span></span>
<span class=line><span style=color:#032F62>        echo "::set-output name=config::$(jq -c &#x3C; "$CONFIG_FILE")"</span></span>
<span class=line><span style=color:#22863A>      env</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>        CONFIG_FILE</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.TARGET }}/deploy.json</span></span>
<span class=line><span style=color:#22863A>  deploy-azure-keyvault</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>    name</span><span style=color:#24292E>: </span><span style=color:#032F62>Deploy to Azure KeyVault (${<span></span>{ matrix.vault-name }})</span></span>
<span class=line><span style=color:#22863A>    runs-on</span><span style=color:#24292E>: </span><span style=color:#032F62>ubuntu-latest</span></span>
<span class=line><span style=color:#22863A>    needs</span><span style=color:#24292E>: [</span><span style=color:#032F62>issue-push</span><span style=color:#24292E>, </span><span style=color:#032F62>deployment-config</span><span style=color:#24292E>]</span></span>
<span class=line><span style=color:#22863A>    if</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ fromJson(needs.deployment-config.outputs.config).azure-keyvault }}</span></span>
<span class=line><span style=color:#22863A>    strategy</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>      fail-fast</span><span style=color:#24292E>: </span><span style=color:#005CC5>false</span></span>
<span class=line><span style=color:#22863A>      matrix</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>        include</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ fromJson(needs.deployment-config.outputs.config).azure-keyvault }}</span></span>
<span class=line><span style=color:#22863A>    steps</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#24292E>    - </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>Checkout output branch</span></span>
<span class=line><span style=color:#22863A>      uses</span><span style=color:#24292E>: </span><span style=color:#032F62>actions/checkout@v2</span></span>
<span class=line><span style=color:#22863A>      with</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>        ref</span><span style=color:#24292E>: </span><span style=color:#032F62>certs-${<span></span>{ env.TARGET }}</span></span>
<span class=line><span style=color:#22863A>        path</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.CERTS_OUTPUT_DIRECTORY }}</span></span>
<span class=line><span style=color:#24292E>    - </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>Login to Azure</span></span>
<span class=line><span style=color:#22863A>      uses</span><span style=color:#24292E>: </span><span style=color:#032F62>azure/login@v1</span></span>
<span class=line><span style=color:#22863A>      with</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>        creds</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ secrets.AZURE_CREDENTIALS }}</span></span>
<span class=line><span style=color:#24292E>    - </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>Upload certificate</span></span>
<span class=line><span style=color:#22863A>      uses</span><span style=color:#24292E>: </span><span style=color:#032F62>azure/CLI@v1</span></span>
<span class=line><span style=color:#22863A>      with</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>        inlineScript</span><span style=color:#24292E>: </span><span style=color:#D73A49>|</span></span>
<span class=line><span style=color:#032F62>          az keyvault certificate import --subscription "$AZURE_SUBSCRIPTION" \</span></span>
<span class=line><span style=color:#032F62>                                         --vault-name "$AZURE_KEY_VAULT_NAME" \</span></span>
<span class=line><span style=color:#032F62>                                         --file "$CERTS_OUTPUT_DIRECTORY/$FILE_PFX" \</span></span>
<span class=line><span style=color:#032F62>                                         --name "$AZURE_KEY_CERTIFICATE_NAME" \</span></span>
<span class=line><span style=color:#032F62>                                         --password "$PFX_PASSWORD"</span></span>
<span class=line><span style=color:#22863A>      env</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>        AZURE_SUBSCRIPTION</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ matrix.subscription }}</span></span>
<span class=line><span style=color:#22863A>        AZURE_KEY_VAULT_NAME</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ matrix.vault-name }}</span></span>
<span class=line><span style=color:#22863A>        AZURE_KEY_CERTIFICATE_NAME</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ matrix.certificate-name }}</span></span>
<span class=line><span style=color:#22863A>  deploy-azure-webapp</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>    name</span><span style=color:#24292E>: </span><span style=color:#032F62>Deploy to Azure Web App (${<span></span>{ matrix.name }})</span></span>
<span class=line><span style=color:#22863A>    runs-on</span><span style=color:#24292E>: </span><span style=color:#032F62>ubuntu-latest</span></span>
<span class=line><span style=color:#22863A>    needs</span><span style=color:#24292E>: [</span><span style=color:#032F62>issue-push</span><span style=color:#24292E>, </span><span style=color:#032F62>deployment-config</span><span style=color:#24292E>]</span></span>
<span class=line><span style=color:#22863A>    if</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ fromJson(needs.deployment-config.outputs.config).azure-webapp }}</span></span>
<span class=line><span style=color:#22863A>    strategy</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>      fail-fast</span><span style=color:#24292E>: </span><span style=color:#005CC5>false</span></span>
<span class=line><span style=color:#22863A>      matrix</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>        include</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ fromJson(needs.deployment-config.outputs.config).azure-webapp }}</span></span>
<span class=line><span style=color:#22863A>    steps</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#24292E>    - </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>Checkout output branch</span></span>
<span class=line><span style=color:#22863A>      uses</span><span style=color:#24292E>: </span><span style=color:#032F62>actions/checkout@v2</span></span>
<span class=line><span style=color:#22863A>      with</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>        ref</span><span style=color:#24292E>: </span><span style=color:#032F62>certs-${<span></span>{ env.TARGET }}</span></span>
<span class=line><span style=color:#22863A>        path</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.CERTS_OUTPUT_DIRECTORY }}</span></span>
<span class=line><span style=color:#24292E>    - </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>Deploy certificate</span></span>
<span class=line><span style=color:#22863A>      uses</span><span style=color:#24292E>: </span><span style=color:#032F62>Menci/deploy-certificate-to-azure-web-app@main</span></span>
<span class=line><span style=color:#22863A>      with</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>        azcliversion</span><span style=color:#24292E>: </span><span style=color:#005CC5>2.28.0</span></span>
<span class=line><span style=color:#22863A>        creds</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ secrets.AZURE_CREDENTIALS }}</span></span>
<span class=line><span style=color:#22863A>        subscription</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ matrix.subscription }}</span></span>
<span class=line><span style=color:#22863A>        resource-group</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ matrix.resource-group }}</span></span>
<span class=line><span style=color:#22863A>        webapp-name</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ matrix.webapp-name }}</span></span>
<span class=line><span style=color:#22863A>        certificate-file</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.CERTS_OUTPUT_DIRECTORY }}/${<span></span>{ env.FILE_PFX }}</span></span>
<span class=line><span style=color:#22863A>        certificate-password</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.PFX_PASSWORD }}</span></span>
<span class=line><span style=color:#22863A>        delete-old-certificates</span><span style=color:#24292E>: </span><span style=color:#005CC5>true</span></span>
<span class=line><span style=color:#22863A>  deploy-aliyun</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>    name</span><span style=color:#24292E>: </span><span style=color:#032F62>Deploy to Aliyun (${<span></span>{ matrix.certificate-name }})</span></span>
<span class=line><span style=color:#22863A>    runs-on</span><span style=color:#24292E>: </span><span style=color:#032F62>ubuntu-latest</span></span>
<span class=line><span style=color:#22863A>    needs</span><span style=color:#24292E>: [</span><span style=color:#032F62>issue-push</span><span style=color:#24292E>, </span><span style=color:#032F62>deployment-config</span><span style=color:#24292E>]</span></span>
<span class=line><span style=color:#22863A>    if</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ fromJson(needs.deployment-config.outputs.config).aliyun }}</span></span>
<span class=line><span style=color:#22863A>    strategy</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>      fail-fast</span><span style=color:#24292E>: </span><span style=color:#005CC5>false</span></span>
<span class=line><span style=color:#22863A>      matrix</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>        include</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ fromJson(needs.deployment-config.outputs.config).aliyun }}</span></span>
<span class=line><span style=color:#22863A>    steps</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#24292E>    - </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>Checkout output branch</span></span>
<span class=line><span style=color:#22863A>      uses</span><span style=color:#24292E>: </span><span style=color:#032F62>actions/checkout@v2</span></span>
<span class=line><span style=color:#22863A>      with</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>        ref</span><span style=color:#24292E>: </span><span style=color:#032F62>certs-${<span></span>{ env.TARGET }}</span></span>
<span class=line><span style=color:#22863A>        path</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.CERTS_OUTPUT_DIRECTORY }}</span></span>
<span class=line><span style=color:#24292E>    - </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>Deploy certificate</span></span>
<span class=line><span style=color:#22863A>      uses</span><span style=color:#24292E>: </span><span style=color:#032F62>Menci/deploy-certificate-to-aliyun@main</span></span>
<span class=line><span style=color:#22863A>      with</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>        access-key-id</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ secrets.ALIYUN_ACCESS_KEY_ID }}</span></span>
<span class=line><span style=color:#22863A>        access-key-secret</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ secrets.ALIYUN_ACCESS_KEY_SECRET }}</span></span>
<span class=line><span style=color:#22863A>        fullchain-file</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.CERTS_OUTPUT_DIRECTORY }}/${<span></span>{ env.FILE_FULLCHAIN }}</span></span>
<span class=line><span style=color:#22863A>        key-file</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.CERTS_OUTPUT_DIRECTORY }}/${<span></span>{ env.FILE_KEY }}</span></span>
<span class=line><span style=color:#22863A>        certificate-name</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ matrix.certificate-name }}</span></span>
<span class=line><span style=color:#22863A>        cdn-domains</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ join(matrix.cdn-domains, ' ') }}</span></span>
<span class=line><span style=color:#22863A>  deploy-upyun</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>    name</span><span style=color:#24292E>: </span><span style=color:#032F62>Deploy to Upyun (${<span></span>{ matrix.name }})</span></span>
<span class=line><span style=color:#22863A>    runs-on</span><span style=color:#24292E>: </span><span style=color:#032F62>ubuntu-latest</span></span>
<span class=line><span style=color:#22863A>    needs</span><span style=color:#24292E>: [</span><span style=color:#032F62>issue-push</span><span style=color:#24292E>, </span><span style=color:#032F62>deployment-config</span><span style=color:#24292E>]</span></span>
<span class=line><span style=color:#22863A>    if</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ fromJson(needs.deployment-config.outputs.config).upyun }}</span></span>
<span class=line><span style=color:#22863A>    strategy</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>      fail-fast</span><span style=color:#24292E>: </span><span style=color:#005CC5>false</span></span>
<span class=line><span style=color:#22863A>      matrix</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>        include</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ fromJson(needs.deployment-config.outputs.config).upyun }}</span></span>
<span class=line><span style=color:#22863A>    steps</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#24292E>    - </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>Checkout output branch</span></span>
<span class=line><span style=color:#22863A>      uses</span><span style=color:#24292E>: </span><span style=color:#032F62>actions/checkout@v2</span></span>
<span class=line><span style=color:#22863A>      with</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>        ref</span><span style=color:#24292E>: </span><span style=color:#032F62>certs-${<span></span>{ env.TARGET }}</span></span>
<span class=line><span style=color:#22863A>        path</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.CERTS_OUTPUT_DIRECTORY }}</span></span>
<span class=line><span style=color:#24292E>    - </span><span style=color:#22863A>name</span><span style=color:#24292E>: </span><span style=color:#032F62>Deploy certificate</span></span>
<span class=line><span style=color:#22863A>      uses</span><span style=color:#24292E>: </span><span style=color:#032F62>Menci/deploy-certificate-to-upyun@main</span></span>
<span class=line><span style=color:#22863A>      with</span><span style=color:#24292E>:</span></span>
<span class=line><span style=color:#22863A>        subaccount-username</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ secrets.UPYUN_SUBACCOUNT_USERNAME }}</span></span>
<span class=line><span style=color:#22863A>        subaccount-password</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ secrets.UPYUN_SUBACCOUNT_PASSWORD }}</span></span>
<span class=line><span style=color:#22863A>        fullchain-file</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.CERTS_OUTPUT_DIRECTORY }}/${<span></span>{ env.FILE_FULLCHAIN }}</span></span>
<span class=line><span style=color:#22863A>        key-file</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ env.CERTS_OUTPUT_DIRECTORY }}/${<span></span>{ env.FILE_KEY }}</span></span>
<span class=line><span style=color:#22863A>        domains</span><span style=color:#24292E>: </span><span style=color:#032F62>${<span></span>{ join(matrix.domains, ' ') }}</span></span>
<span class=line><span style=color:#22863A>        delete-unused-certificates</span><span style=color:#24292E>: </span><span style=color:#005CC5>true</span></span>
<span class=line></span></code></pre></div><p>部署配置（<code class="punctuation-r punctuation-l">main/deploy.json</code>）的格式：</p><div class=flex-wrapper><pre><code class=language-json><span class=line><span style=color:#24292E>{</span></span>
<span class=line><span style=color:#005CC5>  "azure-keyvault"</span><span style=color:#24292E>: [</span></span>
<span class=line><span style=color:#24292E>    {</span></span>
<span class=line><span style=color:#005CC5>      "subscription"</span><span style=color:#24292E>: </span><span style=color:#032F62>""</span><span style=color:#24292E>,</span></span>
<span class=line><span style=color:#005CC5>      "vault-name"</span><span style=color:#24292E>: </span><span style=color:#032F62>""</span><span style=color:#24292E>,</span></span>
<span class=line><span style=color:#005CC5>      "certificate-name"</span><span style=color:#24292E>: </span><span style=color:#032F62>""</span></span>
<span class=line><span style=color:#24292E>    }</span></span>
<span class=line><span style=color:#24292E>  ],</span></span>
<span class=line><span style=color:#005CC5>  "azure-webapp"</span><span style=color:#24292E>: [</span></span>
<span class=line><span style=color:#24292E>    {</span></span>
<span class=line><span style=color:#005CC5>      "name"</span><span style=color:#24292E>: </span><span style=color:#032F62>"&#x3C;显示名称>"</span><span style=color:#24292E>,</span></span>
<span class=line><span style=color:#005CC5>      "subscription"</span><span style=color:#24292E>: </span><span style=color:#032F62>""</span><span style=color:#24292E>,</span></span>
<span class=line><span style=color:#005CC5>      "resource-group"</span><span style=color:#24292E>: </span><span style=color:#032F62>""</span><span style=color:#24292E>,</span></span>
<span class=line><span style=color:#005CC5>      "webapp-name"</span><span style=color:#24292E>: </span><span style=color:#032F62>""</span></span>
<span class=line><span style=color:#24292E>    }</span></span>
<span class=line><span style=color:#24292E>  ],</span></span>
<span class=line><span style=color:#005CC5>  "aliyun"</span><span style=color:#24292E>: [</span></span>
<span class=line><span style=color:#24292E>    {</span></span>
<span class=line><span style=color:#005CC5>      "certificate-name"</span><span style=color:#24292E>: </span><span style=color:#032F62>""</span><span style=color:#24292E>,</span></span>
<span class=line><span style=color:#005CC5>      "cdn-domains"</span><span style=color:#24292E>: [</span></span>
<span class=line><span style=color:#032F62>        "example.com"</span><span style=color:#24292E>,</span></span>
<span class=line><span style=color:#032F62>        "example.net"</span></span>
<span class=line><span style=color:#24292E>      ]</span></span>
<span class=line><span style=color:#24292E>    }</span></span>
<span class=line><span style=color:#24292E>  ],</span></span>
<span class=line><span style=color:#005CC5>  "upyun"</span><span style=color:#24292E>: [</span></span>
<span class=line><span style=color:#24292E>    {</span></span>
<span class=line><span style=color:#005CC5>      "name"</span><span style=color:#24292E>: </span><span style=color:#032F62>"&#x3C;显示名称>"</span><span style=color:#24292E>,</span></span>
<span class=line><span style=color:#005CC5>      "domains"</span><span style=color:#24292E>: [</span></span>
<span class=line><span style=color:#032F62>        "example.com"</span><span style=color:#24292E>,</span></span>
<span class=line><span style=color:#032F62>        "example.net"</span></span>
<span class=line><span style=color:#24292E>      ]</span></span>
<span class=line><span style=color:#24292E>    }</span></span>
<span class=line><span style=color:#24292E>  ]</span></span>
<span class=line><span style=color:#24292E>}</span></span>
<span class=line></span></code></pre></div><h1 id=%E5%85%B3%E4%BA%8E-gts-%E8%AF%81%E4%B9%A6 tabindex=-1>关于 GTS 证书 <a class=headerlink href=#%E5%85%B3%E4%BA%8E-gts-%E8%AF%81%E4%B9%A6></a></h1><p>最近 Google Cloud 推出了基于 Google Trust Service（GTS）的 SSL 证书服务，可参考<a target=_blank rel=noopener href=https://www.julydate.com/post/1888545210/ >此文章</a>（<a target=_blank rel=noopener href=https://archive.is/EgPat>存档</a>）进行申请。acme.sh 也在第一时间<a target=_blank rel=noopener href=https://github.com/acmesh-official/acme.sh/commit/fb5091a388c6cb4280cd095ab74056697be21a54>添加了</a>对 GTS 的支持。</p><p>GTS 证书的亮点有：</p><ol><li>使用与 <a target=_blank rel=noopener href=https://www.google.com>Google.com</a> 相同的根证书 GTS Root R1，交叉签名了有效期从 1998 至 2028 的 GlobalSign Root CA，兼容性较好。而 Let's Encrypt 的根证书 ISRG Root X1 所交叉签名的 DST Root CA X3 已过期，仅有的 ISRG Root X1 在一些旧设备和未更新的系统上未被信任。</li><li>支持自定义证书有效期，可以设置有效期 1 天到 90 天。</li><li>其 OCSP 服务在中国大陆设有节点，国内查询速度较快。</li></ol><p>而 GTS 相较于 Let's Encrypt 的不足之处有：</p><ol><li>不支持使用 Punycode 编码的域名（即含有中文、Emoji 等字符的域名）。</li><li>由于其根证书 GTS Root R1 和中间证书 GTS CA 1P5 均为 RSA 证书，GTS 无法提供全链 ECC 证书。而 Let's Encrypt 可以通过 <a target=_blank rel=noopener href=https://letsencrypt.org/2020/09/17/new-root-and-intermediates.html>ISRG Root X2</a> 提供。</li></ol><p>由于 Firefox <a target=_blank rel=noopener href=https://wiki.mozilla.org/CA/Revocation_Checking_in_Firefox#Short-Lived_Certificates>不会检验</a>有效期在 10 天内的证书的 OCSP 状态（而 Chrome 默认对任何证书均不检查），所以，申请 10 天以内的证书可能能够提升网站的访问速度（特别是在无法使用 <a target=_blank rel=noopener href=https://en.wikipedia.org/wiki/OCSP_stapling>OCSP stapling</a> 时）。</p></div></div><nav class=post-pagination><a class=newer-posts href=../backup-pve-with-pbs/ >上一篇<br>使用 Proxmox Backup Server 备份 Proxmox VE 的客户机与宿主机 </a><span class=page-number></span> <a class=older-posts href=../x86-userland-and-syscall/ >下一篇<br>在 x86 中实现用户态与系统调用</a></nav><div class=post-comment-wrapper-giscus><div class=giscus></div></div></div></div><div class=single-column-footer>Powered by <a href=https://hexo.io/ target=_blank rel="noreferrer noopener">Hexo</a><br>Theme <a href=https://github.com/Menci/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal</a> by <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a><br>&copy; 2024 <a href=https://blog.men.ci>Menci<i class=material-icons>favorite</i></a></div></div></div><script src=//cdnjs.baoshuo.ren/ajax/libs/jquery/3.3.1/jquery.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/popper.js/1.14.4/umd/popper.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/vue/2.5.17/vue.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/smooth-scroll/14.2.1/smooth-scroll.min.js crossorigin=anonymous></script><script src=//cdnjs.baoshuo.ren/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js crossorigin=anonymous></script><script src=//static.cdn.menci.xyz/menci-blog/js/journal.bde01167.min.js crossorigin=anonymous></script><script src=//giscus.api.menci.xyz/client.js data-repo=Menci/blog data-repo-id=R_kgDOGsK5nA data-category=Comments data-category-id=DIC_kwDOGsK5nM4CAulO data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-theme=menci-blog data-lang=zh-CN async></script><script>"serviceWorker"in navigator&&window.addEventListener("load",(function(){navigator.serviceWorker.register("/sw.js?t=https%3A%2F%2Fstatic.cdn.menci.xyz%2Fmenci-blog%2F")}));</script></body></html>